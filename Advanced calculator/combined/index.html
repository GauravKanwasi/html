<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exam-Calc — Ultimate+ (Validation, Units, LaTeX, PDF, Sounds)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<!-- MathJax for LaTeX rendering in history -->
<script>
  window.MathJax = {
    tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]},
    svg: {fontCache: 'global'}
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<!-- html2canvas + jsPDF for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg-1:#f3f6f9; --bg-2:#eef3f7;
  --panel:#223244; --panel-2:#2e4458; --accent:#f6b042; --muted:#90a4ae;
  --radius:14px; --shadow-1:0 10px 30px rgba(34,50,68,0.12);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));font-family:'Inter',system-ui,Arial,sans-serif;color:#0b2336}
body{display:flex;align-items:center;justify-content:center;padding:18px;-webkit-font-smoothing:antialiased}
.calc-wrap{width:96vw;max-width:1100px}
.calc{border-radius:var(--radius);background:linear-gradient(180deg,#ffffff,#f6fbff);box-shadow:var(--shadow-1);display:grid;grid-template-columns:1fr 380px;gap:18px;padding:18px;position:relative}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:8px 12px}
.brand h1{font-family:'Patrick Hand',cursive;margin:0;font-size:1.5rem;color:#123447}
.brand small{display:block;color:var(--muted);font-size:0.78rem;margin-top:2px}
.main{background:linear-gradient(180deg,#ffffff,#f3f8fb);border-radius:12px;padding:14px;box-shadow:0 6px 16px rgba(3,17,28,0.04);min-height:620px;position:relative}
.display{background:linear-gradient(180deg,#fbfdff,#eef6ff);border-radius:12px;padding:14px;border:1px solid rgba(3,17,28,0.04);box-shadow: inset 0 2px 8px rgba(16,40,60,0.03)}
#history{font-size:0.9rem;color:var(--muted);text-align:right;min-height:20px;margin-bottom:6px;padding-right:6px}
#preview{ text-align:right;color:var(--accent);min-height:18px;margin-top:6px;font-size:0.92rem}
#display{width:100%;height:76px;border-radius:10px;border:none;padding:12px 14px;font-size:2rem;font-weight:700;text-align:right;background:#fff;color:#0a2230;box-shadow:inset 0 6px 18px rgba(16,40,60,0.03)}
.keys{margin-top:12px;display:grid;gap:10px}
.row{display:grid;grid-template-columns:repeat(8,1fr);gap:10px}
.key{border-radius:10px;padding:10px 8px;cursor:pointer;border:none;font-weight:700;color:white;box-shadow:0 8px 20px rgba(3,17,28,0.06);transition:transform .12s,border-color .12s;display:flex;align-items:center;justify-content:center}
.key:active{transform:translateY(1px) scale(.996)}
.num{background:linear-gradient(180deg,#7d8a91,#6b7880)}
.op{background:linear-gradient(180deg,#f39c12,#d35400)}
.eq{background:linear-gradient(180deg,#27ae60,#188c43)}
.clr{background:linear-gradient(180deg,#e74c3c,#c0392b)}
.sci{background:linear-gradient(180deg,#3498db,#2e7bb9)}
.mem{background:linear-gradient(180deg,#9b59b6,#8b3fb0)}
.side{background:linear-gradient(180deg,#ffffff,#f6fbff);border-radius:12px;padding:12px;box-shadow:0 6px 16px rgba(3,17,28,0.04);min-height:620px;display:flex;flex-direction:column;gap:12px}
.sticky{background:linear-gradient(180deg,#fff7e6,#fff5e0);border-radius:10px;padding:10px;color:#5b3b00;box-shadow:0 6px 20px rgba(217,164,60,0.06)}
.history-list{max-height:300px;overflow:auto;padding:6px;border-radius:8px;background:linear-gradient(180deg,#fbfdff,#f3f8fb);border:1px dashed rgba(3,17,28,0.03)}
.history-item{padding:8px;border-bottom:1px solid rgba(3,17,28,0.04);display:flex;justify-content:space-between;gap:8px;align-items:center}
.history-item:last-child{border-bottom:none}
.history-item small{color:#446;display:block;margin-top:4px}
.autocomplete{position:absolute;right:92px;top:120px;min-width:320px;background:#10171b;color:#fff;border-radius:10px;box-shadow:0 18px 36px rgba(0,0,0,0.5);padding:6px;display:none;z-index:150}
.autocomplete .suggest{padding:8px;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;gap:8px}
.autocomplete .suggest:hover{background:rgba(255,255,255,0.03)}
.hint{position:absolute;left:22px;top:120px;min-width:300px;background:#f6fffb;color:#0b3b3a;padding:10px;border-radius:10px;display:none;box-shadow:0 12px 30px rgba(3,17,28,0.06);z-index:150}
.hint.warning{background:#fff1f0;color:#4b0b09;border:1px solid rgba(200,60,60,0.12)}
.tooltip{position:fixed;pointer-events:none;padding:8px 10px;border-radius:8px;background:#0f1720;color:#fff;font-size:0.87rem;box-shadow:0 12px 30px rgba(3,17,28,0.5);display:none;z-index:160}
.settings{display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:8px;border:1px solid rgba(3,17,28,0.03)}
.modal-backdrop{position:fixed;inset:0;background:rgba(6,10,12,0.45);display:none;align-items:center;justify-content:center;z-index:200}
.modal{background:#fff;padding:18px;border-radius:12px;width:720px;max-width:94vw;box-shadow:0 20px 60px rgba(0,0,0,0.45)}
.footer{grid-column:1/-1;padding-top:8px;display:flex;justify-content:space-between;color:var(--muted);font-size:0.85rem}
.notebook-mode .calc{background:linear-gradient(180deg,#fbf9f1,#f7f6ec)}
.notebook-mode #display{font-family:'Patrick Hand',cursive;color:#123447;background:linear-gradient(180deg,#fffdf6,#fff9ec)}
@media (max-width:1000px){ .calc{grid-template-columns:1fr; } .autocomplete{right:18px;top:220px} .hint{left:18px;top:200px} .side{order:2} .main{order:1} }
</style>
</head>
<body>

<div class="calc-wrap">
  <div class="calc" id="calc">
    <div class="header">
      <div class="brand">
        <div>
          <h1>Exam-Calc</h1>
          <small>ultimate toolkit — validation, units, LaTeX, PDF, sounds</small>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="openOnboarding" class="key sci" style="background:#6ea6c8;padding:8px 10px;font-weight:600"><i class="fas fa-book-open"></i> Quick start</button>
        <button id="showShortcuts" class="key sci" style="background:#9ecb8b;padding:8px 10px;font-weight:600"><i class="fas fa-keyboard"></i> Shortcuts</button>
      </div>
    </div>

    <div class="main" id="mainArea">
      <div class="display" id="displayArea">
        <div id="history">&nbsp;</div>
        <div id="preview">Type an expression — validation and preview will appear here.</div>
        <input id="display" type="text" disabled value="0" aria-label="Calculator display"/>
        <div id="validationMessage" class="hint" style="display:none"></div>
      </div>

      <div class="keys" id="keys" style="margin-top:14px">
        <!-- buttons -->
        <div class="row">
          <button class="key clr" data-action="clear">AC</button>
          <button class="key clr" data-action="back">⌫</button>
          <button class="key sci" data-fn="sqrt">√</button>
          <button class="key sci" data-fn="pow">xⁿ</button>
          <button class="key op" data-val="/">÷</button>
          <button class="key mem" data-action="mc">MC</button>
          <button class="key sci" data-fn="nCr">nCr</button>
          <button class="key sci" data-fn="nPr">nPr</button>
        </div>
        <div class="row">
          <button class="key sci" data-fn="sin">sin</button>
          <button class="key sci" data-fn="cos">cos</button>
          <button class="key sci" data-fn="tan">tan</button>
          <button class="key sci" data-fn="asin">asin</button>
          <button class="key sci" data-fn="acos">acos</button>
          <button class="key mem" data-action="mr">MR</button>
          <button class="key sci" data-fn="sinh">sinh</button>
          <button class="key sci" data-fn="cosh">cosh</button>
        </div>
        <div class="row">
          <button class="key num" data-val="7">7</button>
          <button class="key num" data-val="8">8</button>
          <button class="key num" data-val="9">9</button>
          <button class="key op" data-val="*">×</button>
          <button class="key sci" data-fn="fact">x!</button>
          <button class="key mem" data-action="mplus">M+</button>
          <button class="key sci" data-fn="gcd">gcd</button>
          <button class="key sci" data-fn="lcm">lcm</button>
        </div>
        <div class="row">
          <button class="key num" data-val="4">4</button>
          <button class="key num" data-val="5">5</button>
          <button class="key num" data-val="6">6</button>
          <button class="key op" data-val="-">−</button>
          <button class="key sci" data-fn="abs">|x|</button>
          <button class="key mem" data-action="mminus">M-</button>
          <button class="key sci" data-fn="isprime">isPrime</button>
          <button class="key sci" data-fn="pfactor">pfactor</button>
        </div>
        <div class="row">
          <button class="key num" data-val="1">1</button>
          <button class="key num" data-val="2">2</button>
          <button class="key num" data-val="3">3</button>
          <button class="key op" data-val="+">+</button>
          <button class="key sci" data-fn="exp">eˣ</button>
          <button class="key sci" data-fn="rand">RND</button>
          <button class="key sci" data-fn="asinh">asinh</button>
          <button class="key sci" data-fn="tanh">tanh</button>
        </div>
        <div class="row">
          <button class="key num" data-val="0">0</button>
          <button class="key num" data-val=".">.</button>
          <button class="key op" data-val="(">(</button>
          <button class="key op" data-val=")">)</button>
          <button class="key eq" data-action="equals">=</button>
          <button class="key sci" data-fn="pi">π</button>
          <button class="key sci" data-fn="floor">floor</button>
          <button class="key sci" data-fn="ceil">ceil</button>
        </div>

        <!-- Unit conversion quick input -->
        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="unitInput" placeholder="Try: 10 km to m" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(3,17,28,0.06)"/>
          <button id="convertBtn" class="key sci" style="padding:8px 12px;background:#8ac6ff">Convert</button>
        </div>

      </div>
    </div>

    <aside class="side">
      <div class="sticky">
        <h4>Quick tips</h4>
        <p>Type math expressions like <code>sin(30)</code>, factorial <code>5!</code>, or unit conversions like <code>10 km to m</code>. Invalid arguments trigger in-place hints so you can fix mistakes quickly.</p>
      </div>

      <div>
        <strong style="display:block;margin-bottom:8px;color:#123447">History (click to load)</strong>
        <div class="history-list" id="historyList" aria-live="polite"></div>
      </div>

      <div style="margin-top:8px">
        <strong style="display:block;margin-bottom:8px;color:#123447">Settings & Tools</strong>
        <div class="settings">
          <label>Angle mode <span style="float:right" id="angleLabel">DEG</span></label>
          <button id="angleToggle" class="key sci" style="padding:8px 10px;background:#9ecb8b">Deg / Rad</button>

          <label>Precision</label>
          <select id="precision" style="padding:8px;border-radius:8px"><option>6</option><option>4</option><option>2</option><option>0</option><option>12</option></select>

          <label>Notebook mode <small style="color:#666">(handwritten feel)</small></label>
          <button id="notebookToggle" class="key sci" style="background:#e0c68d;padding:8px">Toggle Notebook</button>

          <label>Sound theme</label>
          <div style="display:flex;gap:6px">
            <select id="soundTheme" style="padding:8px;border-radius:8px">
              <option value="none">Off</option>
              <option value="bell">Bell (soft)</option>
              <option value="tap">Tap</option>
              <option value="pop">Pop</option>
            </select>
            <button id="testSound" class="key" style="background:#eef;padding:8px">Test</button>
          </div>

          <label style="margin-top:6px">Export</label>
          <div style="display:flex;gap:8px">
            <button id="exportTxt" class="key" style="background:#f3f3f3;color:#012;padding:8px">Download .txt</button>
            <button id="exportPng" class="key" style="background:#f3f3f3;color:#012;padding:8px">Export PNG</button>
            <button id="exportPdf" class="key" style="background:#f3f3f3;color:#012;padding:8px">Export PDF</button>
          </div>
        </div>
      </div>
    </aside>

    <div class="footer">
      <div>Designed with care — built for students and curious minds.</div>
      <div style="opacity:.8">vUltimate • 4.0</div>
    </div>
  </div>
</div>

<div class="autocomplete" id="autocomplete" role="listbox" aria-hidden="true"></div>
<div class="hint" id="argHint" aria-hidden="true"></div>
<div class="tooltip" id="tooltip" aria-hidden="true"></div>

<!-- Onboarding -->
<div class="modal-backdrop" id="onboardingModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Welcome to Exam-Calc — Quick tour</h2>
    <p>Type expressions: <code>sin(30)</code>, <code>5!</code>, <code>nCr(10,3)</code>. For unit conversion type: <code>10 km to m</code>. Use the Export buttons to save your work.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="closeOnboarding" class="key sci" style="background:#9ecb8b;padding:8px 12px">Got it — thanks</button>
    </div>
  </div>
</div>

<!-- Shortcuts -->
<div class="modal-backdrop" id="shortcutsModal">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Shortcuts</h2>
    <ul>
      <li><strong>0–9</strong> type numbers</li>
      <li><strong>Enter</strong> evaluate</li>
      <li><strong>Backspace</strong> delete</li>
      <li><strong>Esc</strong> clear</li>
      <li><strong>Arrow Up / Down</strong> navigate autocomplete</li>
    </ul>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="closeShortcuts" class="key sci" style="background:#9ecb8b;padding:8px 12px">Close</button>
    </div>
  </div>
</div>

<script>
/* =========================
   Ultimate Exam-Calc
   - Live validation (argument hints + domain checks)
   - Unit conversion parsing and quick convert
   - LaTeX rendering for history via MathJax
   - Export PNG / PDF using html2canvas + jsPDF
   - Sound themes via WebAudio
   ========================= */

(() => {
  // Elements
  const display = document.getElementById('display');
  const preview = document.getElementById('preview');
  const validationMessage = document.getElementById('validationMessage');
  const historyList = document.getElementById('historyList');
  const autocomplete = document.getElementById('autocomplete');
  const argHint = document.getElementById('argHint');
  const tooltip = document.getElementById('tooltip');

  const openOnboarding = document.getElementById('openOnboarding');
  const onboardingModal = document.getElementById('onboardingModal');
  const closeOnboarding = document.getElementById('closeOnboarding');
  const showShortcuts = document.getElementById('showShortcuts');
  const shortcutsModal = document.getElementById('shortcutsModal');
  const closeShortcuts = document.getElementById('closeShortcuts');

  const angleToggle = document.getElementById('angleToggle');
  const angleLabel = document.getElementById('angleLabel');
  const precisionSelect = document.getElementById('precision');
  const notebookToggle = document.getElementById('notebookToggle');
  const soundTheme = document.getElementById('soundTheme');
  const testSound = document.getElementById('testSound');

  const exportTxt = document.getElementById('exportTxt');
  const exportPng = document.getElementById('exportPng');
  const exportPdf = document.getElementById('exportPdf');

  const unitInput = document.getElementById('unitInput');
  const convertBtn = document.getElementById('convertBtn');

  const keys = document.getElementById('keys');

  // State
  let expr = '';
  let memory = parseFloat(localStorage.getItem('exam_calc_memory') || '0') || 0;
  let history = JSON.parse(localStorage.getItem('exam_calc_history') || '[]');
  let angleMode = localStorage.getItem('exam_calc_angle') || 'deg';
  let precision = parseInt(localStorage.getItem('exam_calc_precision') || '6', 10);
  let notebookMode = localStorage.getItem('exam_calc_notebook') === '1';
  let soundThemeVal = localStorage.getItem('exam_calc_sound') || 'none';

  // Undo stack simple
  let undoStack = [], redoStack = [];

  // catalog for autocomplete + hints
  const catalog = [
    {name:'sin', sig:'sin(x)', desc:'Sine — respects DEG/RAD'},
    {name:'cos', sig:'cos(x)', desc:'Cosine — respects DEG/RAD'},
    {name:'tan', sig:'tan(x)', desc:'Tangent — respects DEG/RAD'},
    {name:'asin', sig:'asin(x)', desc:'Inverse sine (domain -1..1)'},
    {name:'acos', sig:'acos(x)', desc:'Inverse cosine (domain -1..1)'},
    {name:'atan', sig:'atan(x)', desc:'Inverse tangent'},
    {name:'sqrt', sig:'sqrt(x)', desc:'Square root (x >= 0)'},
    {name:'pow', sig:'pow(a,b) or a^b', desc:'Power'},
    {name:'fact', sig:'fact(n) or n!', desc:'Factorial (integer >= 0)'},
    {name:'nCr', sig:'nCr(n,r)', desc:'Combinations (integers)'},
    {name:'nPr', sig:'nPr(n,r)', desc:'Permutations (integers)'},
    {name:'gcd', sig:'gcd(a,b)', desc:'Greatest common divisor'},
    {name:'lcm', sig:'lcm(a,b)', desc:'Least common multiple'},
    {name:'isprime', sig:'isprime(n)', desc:'Prime test (integer)'},
    {name:'pfactor', sig:'pfactor(n)', desc:'Prime factorization'},
    {name:'ln', sig:'ln(x)', desc:'Natural log (x > 0)'},
    {name:'log', sig:'log(x)', desc:'Log base 10 (x > 0)'},
    {name:'PI', sig:'PI', desc:'π constant'},
    {name:'E', sig:'E', desc:'e constant'},
    {name:'rand', sig:'rand()', desc:'Random number 0..1'},
    {name:'floor', sig:'floor(x)', desc:'Round down'},
    {name:'ceil', sig:'ceil(x)', desc:'Round up'}
  ];

  // --------------------------
  // Math sandbox functions
  // --------------------------
  function factorial(n){
    const k = Math.floor(n);
    if (k < 0 || k !== n || k > 170) throw new Error('Invalid factorial (must be non-negative integer <= 170)');
    let r = 1;
    for (let i=2;i<=k;i++) r *= i;
    return r;
  }
  function gcd(a,b){ a=Math.abs(Math.floor(a)); b=Math.abs(Math.floor(b)); if(!a) return b; if(!b) return a; while(b){ const t=b; b=a%b; a=t; } return a; }
  function lcm(a,b){ if(a===0||b===0) return 0; return Math.abs(Math.floor(a)/gcd(a,b)*Math.floor(b)); }
  function isPrimeSimple(n){ n=Math.floor(n); if(n<=1) return false; if(n<=3) return true; if(n%2===0) return false; const r=Math.floor(Math.sqrt(n)); for(let i=3;i<=r;i+=2) if(n%i===0) return false; return true; }
  function primeFactors(n){ n=Math.abs(Math.floor(n)); const out=[]; let d=2; while(d*d<=n){ while(n%d===0){ out.push(d); n/=d; } d=(d===2)?3:d+2; } if(n>1) out.push(n); return out; }

  function buildSandbox(){
    return {
      sin:x => angleMode==='deg' ? Math.sin(x*Math.PI/180) : Math.sin(x),
      cos:x => angleMode==='deg' ? Math.cos(x*Math.PI/180) : Math.cos(x),
      tan:x => angleMode==='deg' ? Math.tan(x*Math.PI/180) : Math.tan(x),
      asin:x => angleMode==='deg' ? Math.asin(x)*180/Math.PI : Math.asin(x),
      acos:x => angleMode==='deg' ? Math.acos(x)*180/Math.PI : Math.acos(x),
      atan:x => angleMode==='deg' ? Math.atan(x)*180/Math.PI : Math.atan(x),
      sqrt:x => Math.sqrt(x),
      pow:(a,b)=>Math.pow(a,b),
      abs:x=>Math.abs(x),
      exp:x=>Math.exp(x),
      ln:x=>Math.log(x),
      log:x=> (Math.log10?Math.log10(x):Math.log(x)/Math.LN10),
      rand: ()=>Math.random(),
      PI: Math.PI, E: Math.E,
      fact: factorial,
      nCr:(n,r)=>{ n=Math.floor(n); r=Math.floor(r); if(r<0||n<0||r>n) return 0; if(r>n-r) r=n-r; let num=1,den=1; for(let i=1;i<=r;i++){ num*=(n-r+i); den*=i; } return Math.round(num/den); },
      nPr:(n,r)=>{ n=Math.floor(n); r=Math.floor(r); if(r<0||n<0||r>n) return 0; let res=1; for(let i=0;i<r;i++) res*=(n-i); return res; },
      gcd:(a,b)=>gcd(a,b), lcm:(a,b)=>lcm(a,b), isprime:(n)=>isPrimeSimple(n), pfactor:(n)=>primeFactors(n),
      floor:x=>Math.floor(x), ceil:x=>Math.ceil(x), round:x=>Math.round(x)
    };
  }

  function preprocess(expression){
    let s = String(expression).replace(/\s+/g,'');
    // factorial: 5! => fact(5)
    const reFact = /(\d+(\.\d+)?|\([^()]*\))!/;
    while (reFact.test(s)) s = s.replace(reFact, 'fact($1)');
    // percent: 50% => (50/100)
    s = s.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
    // ^ operator => pow(a,b)
    s = s.replace(/([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))\^([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))/g, 'pow($1,$3)');
    return s;
  }

  function evaluateExpression(input){
    if(!input || String(input).trim()==='') return '';
    try{
      // Unit conversion branch: "10 km to m" handled earlier before eval
      const processed = preprocess(input);
      const sb = buildSandbox();
      const keys = Object.keys(sb);
      const args = keys.map(k=>sb[k]);
      const fn = new Function(...keys, 'return (' + processed + ');');
      return fn(...args);
    } catch(err){
      return 'Error';
    }
  }

  // -------------------------
  // Unit conversion utilities
  // -------------------------
  const units = {
    length: {
      m:1, km:1000, cm:0.01, mm:0.001, in:0.0254, ft:0.3048, yd:0.9144, mi:1609.344
    },
    mass: {
      g:1, kg:1000, mg:0.001, lb:453.59237, oz:28.349523125
    },
    temp: {
      C: 'C', F: 'F', K: 'K'
    }
  };

  function isTempUnit(u){ return ['c','f','k','°c','°f'].includes(u.toLowerCase()); }

  function convertUnits(value, from, to){
    from = from.trim().toLowerCase();
    to = to.trim().toLowerCase();
    // temperature special handling
    if (isTempUnit(from) || isTempUnit(to)) {
      // normalize
      const f = from[0].toLowerCase();
      const t = to[0].toLowerCase();
      let c;
      if (f === 'c') c = value;
      else if (f === 'f') c = (value - 32) * 5/9;
      else if (f === 'k') c = value - 273.15;
      else throw 'Unsupported temp unit';
      if (t === 'c') return c;
      if (t === 'f') return c * 9/5 + 32;
      if (t === 'k') return c + 273.15;
    }
    // length
    if (units.length[from] && units.length[to]) {
      return value * units.length[from] / units.length[to];
    }
    if (units.mass[from] && units.mass[to]) {
      return value * units.mass[from] / units.mass[to];
    }
    throw 'Incompatible or unknown units';
  }

  function tryParseConversion(input){
    // formats: "10 km to m", "5mi to km", "convert(10, 'km','m')" not supporting quotes parsing
    const m = input.match(/^(-?\d+(\.\d+)?)\s*([A-Za-z°]+)\s+to\s+([A-Za-z°]+)$/i);
    if (m){
      const v = parseFloat(m[1]);
      const from = m[3];
      const to = m[4];
      return {value:v, from, to};
    }
    // allow "10km to m" without space
    const m2 = input.match(/^(-?\d+(\.\d+)?)([A-Za-z°]+)\s+to\s+([A-Za-z°]+)$/i);
    if(m2){
      const v = parseFloat(m2[1]);
      return {value:v, from:m2[3], to:m2[4]};
    }
    return null;
  }

  // -------------------------
  // Validation rules
  // -------------------------
  function validateExpression(expr){
    // Basic parsing to detect function usage and simple domain checks.
    // We'll run a few regexes to find typical function calls and numbers.
    const warnings = [];

    // Factorial: check n! -> argument must be integer >=0 and not too big
    const factCalls = expr.matchAll(/fact\(([^()]+)\)|(\d+)!/g);
    for (const f of factCalls){
      const arg = f[1] || f[2];
      if (arg){
        const val = Number(arg);
        if (!Number.isFinite(val) || val < 0 || Math.floor(val) !== val) warnings.push('factorial requires a non-negative integer');
        if (val > 170) warnings.push('factorial result may overflow (n > 170)');
      }
    }

    // sqrt(x): x >= 0
    const sqrtCalls = expr.matchAll(/sqrt\(([^()]+)\)/g);
    for (const s of sqrtCalls){
      const val = Number(s[1]);
      if (Number.isFinite(val) && val < 0) warnings.push('sqrt requires non-negative argument');
    }

    // ln/log: > 0
    const logCalls = expr.matchAll(/(?:ln|log|log10)\(([^()]+)\)/g);
    for (const l of logCalls){
      const val = Number(l[1]);
      if (Number.isFinite(val) && val <= 0) warnings.push('log/ln require positive argument');
    }

    // arcsin/arccos domain [-1,1]
    const asinCalls = expr.matchAll(/(?:asin|acos)\(([^()]+)\)/g);
    for (const a of asinCalls){
      const val = Number(a[1]);
      if (Number.isFinite(val) && (val < -1 || val > 1)) warnings.push('asin/acos require values between -1 and 1');
    }

    // division by zero check for obvious patterns x/0 or /0)
    if (/[\/]\s*0(?!\d)/.test(expr)) warnings.push('possible division by zero');

    // percent is okay (we convert before eval)
    return [...new Set(warnings)]; // unique
  }

  // -------------------------
  // UI utility helpers
  // -------------------------
  function fmtNum(v){
    if (typeof v === 'number' && isFinite(v)){
      if (precision === 0) return String(Math.round(v));
      return Number.parseFloat(v).toFixed(precision).replace(/\.?0+$/,'');
    }
    return String(v);
  }

  function pushHistory(e, r){
    history.push({expr:e, result:r, ts: Date.now()});
    if (history.length > 600) history.shift();
    localStorage.setItem('exam_calc_history', JSON.stringify(history));
    renderHistoryList();
  }

  function renderHistoryList(){
    historyList.innerHTML = '';
    if (!history.length){
      historyList.innerHTML = '<div style="padding:10px;color:#456">No history yet.</div>';
      return;
    }
    for (let i = history.length - 1; i >= 0; i--){
      const item = history[i];
      const el = document.createElement('div');
      el.className = 'history-item';
      // Show LaTeX for result and expression
      const latexExpr = escapeHtml(item.expr);
      const latexRes = escapeHtml(fmtNum(item.result));
      el.innerHTML = `<div style="flex:1"><strong>\$${latexExpr}\$</strong><small>\$${latexRes}\$</small></div>
        <div style="display:flex;gap:6px">
          <button data-load="${i}">Load</button>
          <button data-copy="${i}">Copy</button>
        </div>`;
      historyList.appendChild(el);
      // render mathjax for the new node (after adding)
      MathJax.typesetPromise([el]).catch(()=>{});
    }
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // -------------------------
  // Autocomplete + hints
  // -------------------------
  let suggestions = [], suggestionIndex = -1;

  function getAlphaToken(){
    const m = expr.match(/[A-Za-z_]+$/);
    return m ? m[0] : '';
  }

  function updateAutocomplete(){
    const token = getAlphaToken();
    if (!token) { hideAutocomplete(); hideArgHint(); return; }
    const low = token.toLowerCase();
    suggestions = catalog.filter(c => c.name.toLowerCase().includes(low)).slice(0, 12);
    suggestionIndex = suggestions.length ? 0 : -1;
    renderAutocomplete();
  }

  function renderAutocomplete(){
    autocomplete.innerHTML = '';
    if (!suggestions.length){ autocomplete.style.display = 'none'; return; }
    suggestions.forEach((s,i) => {
      const d = document.createElement('div');
      d.className = 'suggest';
      d.dataset.index = i;
      d.innerHTML = `<div><strong>${s.name}</strong><div style="font-size:0.85rem;color:#9fd3ff">${s.desc}</div></div><div style="opacity:.9">${s.sig||''}</div>`;
      d.addEventListener('click', ()=> acceptSuggestion(i));
      d.addEventListener('mousemove', (ev)=> showTooltip((s.sig||s.name)+' — '+s.desc, ev.clientX+10, ev.clientY+10));
      d.addEventListener('mouseleave', hideTooltip);
      autocomplete.appendChild(d);
    });
    autocomplete.style.display = 'block';
  }

  function hideAutocomplete(){ autocomplete.style.display = 'none'; suggestions=[]; suggestionIndex=-1; }
  function acceptSuggestion(i){
    if (i < 0 || i >= suggestions.length) return;
    const s = suggestions[i];
    const token = getAlphaToken();
    if (token) expr = expr.slice(0, -token.length);
    expr += (s.sig && s.name !== 'PI' && s.name !== 'E') ? s.name + '(' : s.name;
    renderMain();
    hideAutocomplete();
    updateArgHint();
  }

  function updateArgHint(){
    const m = expr.match(/([A-Za-z_]\w*)\([^()]*$/);
    if (!m){ hideArgHint(); return; }
    const name = m[1];
    const item = catalog.find(c => c.name === name);
    if (!item){ hideArgHint(); return; }
    // Validate arguments if possible
    const warnings = validateExpression(expr);
    if (warnings.length){
      argHint.classList.add('warning');
      argHint.innerHTML = `<strong>${item.sig}</strong><div style="margin-top:6px">${item.desc}</div><div style="margin-top:8px;color:#8b0000">${warnings.join('; ')}</div>`;
    } else {
      argHint.classList.remove('warning');
      argHint.innerHTML = `<strong>${item.sig}</strong><div style="margin-top:6px">${item.desc}</div>`;
    }
    argHint.style.display = 'block';
  }
  function hideArgHint(){ argHint.style.display = 'none'; argHint.classList.remove('warning'); }

  // -------------------------
  // Validation UI & evaluate
  // -------------------------
  function checkAndShowValidation(currentExpr){
    const warnings = validateExpression(currentExpr);
    if (warnings.length){
      validationMessage.classList.add('warning');
      validationMessage.innerHTML = '<strong>Fix before evaluating:</strong><div style="margin-top:6px">'+ warnings.join('<br>') +'</div>';
      validationMessage.style.display = 'block';
      return false;
    } else {
      validationMessage.style.display = 'none';
      return true;
    }
  }

  function evaluateAndShow(){
    // check conversion first
    const conv = tryParseConversion(expr);
    if (conv){
      try {
        const val = convertUnits(conv.value, conv.from, conv.to);
        const out = fmtNum(val);
        pushHistory(expr, val);
        expr = String(val);
        renderMain();
        preview.textContent = '= ' + out;
        return;
      } catch(err){
        preview.textContent = 'Conversion error: ' + err;
        return;
      }
    }

    // validate domain
    if (!checkAndShowValidation(expr)) return;

    const result = evaluateExpression(expr);
    if (result === 'Error'){
      preview.textContent = 'Error';
    } else {
      preview.textContent = '= ' + fmtNum(result);
      pushHistory(expr, result);
      expr = String(result);
      renderMain();
    }
  }

  // -------------------------
  // Sound themes via WebAudio
  // -------------------------
  let audioCtx = null;
  function initAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
  function playTheme(theme){
    if (!audioCtx) initAudio();
    if (!audioCtx) return;
    try{
      const now = audioCtx.currentTime;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      if (theme === 'bell'){
        o.type = 'sine'; o.frequency.setValueAtTime(880, now); g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.06, now + 0.003); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.14);
      } else if (theme === 'tap'){
        o.type = 'square'; o.frequency.setValueAtTime(1200, now); g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.04, now + 0.002); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);
      } else if (theme === 'pop'){
        o.type = 'triangle'; o.frequency.setValueAtTime(660, now); g.gain.setValueAtTime(0.0001, now);
        g.gain.linearRampToValueAtTime(0.05, now + 0.002); g.gain.exponentialRampToValueAtTime(0.0001, now + 0.09);
      }
      o.start(now); o.stop(now + 0.15);
    } catch (e){}
  }

  // -------------------------
  // Exports (PNG & PDF)
  // -------------------------
  async function exportPNG(){
    const node = document.querySelector('.calc');
    try {
      const canvas = await html2canvas(node, {scale: 2, backgroundColor: null});
      const dataUrl = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = dataUrl; a.download = 'exam-calc.png'; a.click();
    } catch(e){
      alert('Export PNG failed: ' + (e && e.message ? e.message : 'unknown'));
    }
  }

  async function exportPDF(){
    const node = document.querySelector('.calc');
    try {
      const canvas = await html2canvas(node, {scale:2, backgroundColor: null});
      const imgData = canvas.toDataURL('image/png');
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'pt',
        format: [canvas.width, canvas.height]
      });
      pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
      pdf.save('exam-calc.pdf');
    } catch(e){
      alert('Export PDF failed: ' + (e && e.message ? e.message : 'unknown'));
    }
  }

  // -------------------------
  // UI wiring
  // -------------------------
  function renderMain(){
    display.value = expr || '0';
    document.getElementById('history').textContent = history.length ? history[history.length-1].expr + ' =' : '\u00A0';
    localStorage.setItem('exam_calc_history', JSON.stringify(history));
    localStorage.setItem('exam_calc_memory', String(memory));
  }

  function schedulePreview(){
    const conv = tryParseConversion(expr);
    if (conv) {
      try { const val = convertUnits(conv.value, conv.from, conv.to); preview.textContent = '= ' + fmtNum(val); } catch(e){ preview.textContent = 'Conversion error'; }
      return;
    }
    // validation and preview
    const warnings = validateExpression(expr);
    if (warnings.length){
      preview.textContent = '⚠ ' + warnings.join('; ');
      validationMessage.style.display = 'block';
      validationMessage.innerHTML = '<strong>Warning:</strong><div>' + warnings.join('<br>') + '</div>';
    } else {
      validationMessage.style.display = 'none';
      const val = evaluateExpression(expr);
      if (val === 'Error') preview.textContent = '…';
      else preview.textContent = (val === '' ? '' : '= ' + fmtNum(val));
    }
    updateArgHint();
  }

  // button clicks
  keys.addEventListener('click', e=>{
    const btn = e.target.closest('.key');
    if (!btn) return;
    const val = btn.getAttribute('data-val');
    const fn = btn.getAttribute('data-fn');
    const action = btn.getAttribute('data-action');

    // play sound
    if (soundThemeVal && soundThemeVal !== 'none') playTheme(soundThemeVal);

    if (val){ expr += val; renderMain(); schedulePreview(); updateAutocomplete(); }
    else if (fn){
      if (!expr){
        if (fn === 'pi') expr += 'PI';
        else if (fn === 'rand') expr += 'rand()';
        else expr += fn + '(';
      } else {
        if (['fact','rand','pi','isprime','pfactor'].includes(fn)){
          if (fn === 'fact') expr = 'fact(' + expr + ')';
          else if (fn === 'rand') expr = 'rand()';
          else if (fn === 'pi') expr += 'PI';
          else if (fn === 'isprime') expr = 'isprime(' + expr + ')';
          else if (fn === 'pfactor') expr = 'pfactor(' + expr + ')';
        } else if (fn === 'pow') {
          expr += '^';
        } else {
          expr = fn + '(' + expr + ')';
        }
      }
      renderMain(); schedulePreview(); updateAutocomplete(); updateArgHint();
    }
    else if (action){
      if (action === 'clear'){ expr = ''; renderMain(); preview.textContent = 'Type an expression'; hideAutocomplete(); hideArgHint(); }
      else if (action === 'back'){ expr = expr.slice(0,-1); renderMain(); schedulePreview(); updateAutocomplete(); updateArgHint(); }
      else if (action === 'equals'){ evaluateAndShow(); hideAutocomplete(); hideArgHint(); }
      else if (action === 'mc'){ memory = 0; localStorage.setItem('exam_calc_memory', String(memory)); }
      else if (action === 'mr'){ expr += String(memory); renderMain(); schedulePreview(); }
      else if (action === 'mplus'){ const v = evaluateExpression(expr); if (typeof v === 'number' && isFinite(v)) memory += v; localStorage.setItem('exam_calc_memory', String(memory)); }
      else if (action === 'mminus'){ const v = evaluateExpression(expr); if (typeof v === 'number' && isFinite(v)) memory -= v; localStorage.setItem('exam_calc_memory', String(memory)); }
    }
  });

  // history load/copy
  historyList.addEventListener('click', e=>{
    const load = e.target.getAttribute('data-load');
    const copy = e.target.getAttribute('data-copy');
    if (load !== null){ const it = history[load]; if (it){ expr = it.expr; renderMain(); schedulePreview(); } }
    if (copy !== null){ const it = history[copy]; if (it) navigator.clipboard?.writeText(String(it.result)).catch(()=>{}); }
  });

  // keyboard
  document.addEventListener('keydown', e=>{
    if (autocomplete.style.display === 'block'){
      if (e.key === 'ArrowDown'){ e.preventDefault(); suggestionIndex = (suggestionIndex + 1) % suggestions.length; return; }
      if (e.key === 'ArrowUp'){ e.preventDefault(); suggestionIndex = (suggestionIndex - 1 + suggestions.length) % suggestions.length; return; }
      if (e.key === 'Enter' && suggestionIndex >= 0) { acceptSuggestion(suggestionIndex); return; }
      if (e.key === 'Escape'){ hideAutocomplete(); hideArgHint(); return; }
    }
    if (e.key >= '0' && e.key <= '9'){ expr += e.key; renderMain(); schedulePreview(); updateAutocomplete(); return; }
    if (e.key === '.') { expr += '.'; renderMain(); schedulePreview(); updateAutocomplete(); return; }
    if ('+-*/%^()'.includes(e.key)){ expr += e.key; renderMain(); schedulePreview(); updateArgHint(); return; }
    if (e.key === 'Enter'){ evaluateAndShow(); return; }
    if (e.key === 'Backspace'){ expr = expr.slice(0,-1); renderMain(); schedulePreview(); return; }
    if (e.key === 'Escape'){ expr = ''; renderMain(); preview.textContent = ''; return; }
    if (/^[a-zA-Z]$/.test(e.key)){ expr += e.key; renderMain(); updateAutocomplete(); schedulePreview(); return; }
    if (e.key === '!'){ expr += '!'; renderMain(); schedulePreview(); return; }
  });

  // autocomplete helpers (reuse functions defined earlier)
  function acceptSuggestion(i){
    if (i < 0 || i >= suggestions.length) return;
    const s = suggestions[i];
    const token = getAlphaToken();
    if (token) expr = expr.slice(0, -token.length);
    expr += (s.sig && s.name !== 'PI' && s.name !== 'E') ? s.name + '(' : s.name;
    renderMain(); hideAutocomplete(); updateArgHint();
  }

  function hideAutocomplete(){ autocomplete.style.display = 'none'; suggestions=[]; suggestionIndex=-1; }
  function getAlphaToken(){ const m = expr.match(/[A-Za-z_]+$/); return m ? m[0] : ''; }
  function showTooltip(text, x, y){ tooltip.textContent = text; tooltip.style.left = (x+8)+'px'; tooltip.style.top = (y+8)+'px'; tooltip.style.display = 'block'; }
  function hideTooltip(){ tooltip.style.display = 'none'; }

  // argument hint
  function hideArgHint(){ argHint.style.display = 'none'; argHint.classList.remove('warning'); }
  function updateArgHint(){ 
    const m = expr.match(/([A-Za-z_]\w*)\([^()]*$/);
    if (!m) return hideArgHint();
    const name = m[1];
    const it = catalog.find(c => c.name === name);
    if (!it) return hideArgHint();
    const warnings = validateExpression(expr);
    if (warnings.length) {
      argHint.classList.add('warning');
      argHint.innerHTML = `<strong>${it.sig}</strong><div style="margin-top:6px">${it.desc}</div><div style="margin-top:8px;color:#8b0000">${warnings.join('; ')}</div>`;
    } else {
      argHint.classList.remove('warning');
      argHint.innerHTML = `<strong>${it.sig}</strong><div style="margin-top:6px">${it.desc}</div>`;
    }
    argHint.style.display = 'block';
  }

  // convert button
  convertBtn.addEventListener('click', ()=>{
    const v = unitInput.value.trim();
    if(!v) return;
    const parsed = tryParseConversion(v);
    if(!parsed){ preview.textContent = 'Try format: 10 km to m'; return; }
    try {
      const res = convertUnits(parsed.value, parsed.from, parsed.to);
      preview.textContent = '= ' + fmtNum(res);
      pushHistory(v, res);
    } catch(e) {
      preview.textContent = 'Conversion error: ' + e;
    }
  });

  // onboarding modal
  openOnboarding.addEventListener('click', ()=> onboardingModal.style.display = 'flex');
  closeOnboarding.addEventListener('click', ()=> onboardingModal.style.display = 'none');
  showShortcuts.addEventListener('click', ()=> shortcutsModal.style.display = 'flex');
  closeShortcuts.addEventListener('click', ()=> shortcutsModal.style.display = 'none');

  // angle / precision / notebook toggles
  angleToggle.addEventListener('click', ()=>{ angleMode = angleMode === 'deg' ? 'rad' : 'deg'; angleLabel.textContent = angleMode.toUpperCase(); localStorage.setItem('exam_calc_angle', angleMode); schedulePreview(); });
  precisionSelect.addEventListener('change', ()=>{ precision = parseInt(precisionSelect.value || '6', 10); localStorage.setItem('exam_calc_precision', String(precision)); schedulePreview(); });
  notebookToggle.addEventListener('click', ()=>{ notebookMode = !notebookMode; localStorage.setItem('exam_calc_notebook', notebookMode ? '1' : '0'); document.body.classList.toggle('notebook-mode', notebookMode); });

  // sound theme selector
  soundTheme.value = soundThemeVal || 'none';
  soundTheme.addEventListener('change', ()=>{ soundThemeVal = soundTheme.value; localStorage.setItem('exam_calc_sound', soundThemeVal); });
  testSound.addEventListener('click', ()=>{ if(soundThemeVal && soundThemeVal !== 'none') playTheme(soundThemeVal); });

  // export handlers
  exportTxt.addEventListener('click', ()=> {
    let text = 'Exam-Calc History\n-----------------\n';
    history.forEach(h => text += `${h.expr} = ${fmtNum(h.result)}\n`);
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'exam-calc-history.txt'; a.click(); URL.revokeObjectURL(a.href);
  });
  exportPng.addEventListener('click', exportPNG);
  exportPdf.addEventListener('click', exportPDF);

  // Initialize UI state
  function init(){
    display.value = '0';
    angleLabel.textContent = angleMode.toUpperCase();
    precisionSelect.value = String(precision);
    if (notebookMode) document.body.classList.add('notebook-mode');
    renderHistoryList();
    preview.textContent = 'Type an expression — validation and preview will appear here.';
    // hide modals initially
    onboardingModal.style.display = 'none';
    shortcutsModal.style.display = 'none';
  }
  init();

  // Expose evaluate for debugging
  window.examCalc = { evaluate: evaluateExpression, convertUnits, validateExpression, getState: ()=>({expr,history,angleMode,precision}) };

})();
</script>
</body>
</html>
