<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exam-Calc — Human Plus (Notebook, Onboarding, Export)</title>

<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
  :root{
    --bg-1:#f3f6f9; --bg-2:#eef3f7;
    --panel:#223244; --panel-2:#2e4458; --accent:#f6b042; --muted:#90a4ae;
    --radius:14px; --shadow-1:0 10px 30px rgba(34,50,68,0.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));font-family:'Inter',system-ui,Arial,sans-serif;color:#0b2336}
  body{display:flex;align-items:center;justify-content:center;padding:28px;-webkit-font-smoothing:antialiased}

  /* container */
  .calc-wrap { width:94vw; max-width:980px; }
  .calc {
    border-radius:var(--radius); overflow:visible; background:linear-gradient(180deg,#ffffff,#f6fbff);
    box-shadow:var(--shadow-1); display:grid; grid-template-columns:1fr 360px; gap:18px; padding:18px; position:relative;
  }

  /* Header */
  .header { grid-column:1 / -1; display:flex; justify-content:space-between; align-items:center; padding:8px 12px; gap:12px; }
  .brand h1 { font-family:'Patrick Hand',cursive;margin:0;font-size:1.4rem;color:#123447 }
  .brand small { display:block;color:var(--muted);font-size:0.78rem;margin-top:2px }

  /* Left main */
  .main { background:linear-gradient(180deg,#ffffff,#f3f8fb); border-radius:12px; padding:14px; box-shadow:0 6px 16px rgba(3,17,28,0.04); min-height:560px }
  .display { background:linear-gradient(180deg,#fbfdff,#eef6ff); border-radius:12px; padding:14px; border:1px solid rgba(3,17,28,0.04); }
  #history { font-size:0.85rem; color:var(--muted); text-align:right; min-height:20px; margin-bottom:6px; padding-right:6px; }
  #preview { text-align:right; color:var(--accent); min-height:18px; margin-top:6px; font-size:0.92rem }
  #display { width:100%; height:76px; border-radius:10px; border:none; padding:12px 14px; font-size:2rem; font-weight:700; text-align:right; background:#fff; color:#0a2230; box-shadow: inset 0 6px 18px rgba(16,40,60,0.03) }

  /* Keys */
  .keys { margin-top:12px; display:grid; gap:10px }
  .row { display:grid; grid-template-columns: repeat(8,1fr); gap:10px }
  .key { border-radius:10px; padding:10px 8px; cursor:pointer; border:none; font-weight:700; color:white; box-shadow:0 8px 20px rgba(3,17,28,0.06); transition:transform .12s linear, box-shadow .12s; display:flex;align-items:center;justify-content:center }
  .key:active{ transform: translateY(1px) scale(.996) }
  .num{ background: linear-gradient(180deg,#7d8a91,#6b7880) }
  .op{ background: linear-gradient(180deg,#f39c12,#d35400) }
  .eq{ background: linear-gradient(180deg,#27ae60,#188c43) }
  .clr{ background: linear-gradient(180deg,#e74c3c,#c0392b) }
  .sci{ background: linear-gradient(180deg,#3498db,#2e7bb9) }
  .mem{ background: linear-gradient(180deg,#9b59b6,#8b3fb0) }

  /* Side panel */
  .side { background:linear-gradient(180deg,#ffffff,#f6fbff); border-radius:12px; padding:12px; box-shadow:0 6px 16px rgba(3,17,28,0.04); min-height:560px; display:flex;flex-direction:column;gap:12px }
  .sticky { background:linear-gradient(180deg,#fff7e6,#fff5e0); border-radius:10px; padding:10px; color:#5b3b00; box-shadow:0 6px 20px rgba(217,164,60,0.06) }
  .history-list { max-height:280px; overflow:auto; padding:6px; border-radius:8px; background:linear-gradient(180deg,#fbfdff,#f3f8fb); border:1px dashed rgba(3,17,28,0.03) }
  .history-item { padding:8px; border-bottom:1px solid rgba(3,17,28,0.04); display:flex; justify-content:space-between; gap:8px; align-items:center }
  .history-item button { background:transparent; border:1px solid rgba(3,17,28,0.06); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:0.85rem }

  /* Notebook mode (paper) */
  .notebook-mode .calc { background: linear-gradient(180deg,#fbf9f1,#f7f6ec) }
  .notebook-mode #display { background: linear-gradient(180deg,#fffdf6,#fff9ec); font-family:'Patrick Hand',cursive; color:#123447; }

  /* Onboarding modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(6,10,12,0.45); display:flex; align-items:center; justify-content:center; z-index:200; }
  .modal { background:#fff; padding:18px; border-radius:12px; width:720px; max-width:94vw; box-shadow:0 20px 60px rgba(0,0,0,0.45) }
  .modal h2{ margin:0 0 6px 0; font-family:'Patrick Hand',cursive }
  .modal p{ margin:6px 0; color:#334 }

  /* small panels: tooltip/hint/autocomplete */
  .autocomplete { position:absolute; right:72px; top:120px; min-width:300px; background:#10171b; color:#fff; border-radius:10px; box-shadow:0 18px 36px rgba(0,0,0,0.5); padding:6px; display:none; z-index:150 }
  .autocomplete .suggest { padding:8px; border-radius:8px; cursor:pointer; display:flex; justify-content:space-between; gap:8px; }
  .autocomplete .suggest:hover{ background:rgba(255,255,255,0.03) }
  .hint { position:absolute; left:22px; top:120px; min-width:260px; background:#f6fffb; color:#0b3b3a; padding:10px; border-radius:10px; display:none; box-shadow:0 12px 30px rgba(3,17,28,0.06); z-index:150 }
  .tooltip { position:fixed; pointer-events:none; padding:8px 10px; border-radius:8px; background:#0f1720; color:#fff; font-size:0.87rem; box-shadow:0 12px 30px rgba(3,17,28,0.5); display:none; z-index:160 }

  /* Settings panel */
  .settings { display:flex; flex-direction:column; gap:6px; padding:8px; border-radius:8px; border:1px solid rgba(3,17,28,0.03) }
  .settings label{ font-size:0.9rem; color:#123447; }

  /* footer signature */
  .footer { grid-column:1 / -1; padding-top:8px; display:flex; justify-content:space-between; color:var(--muted); font-size:0.85rem }

  /* responsive */
  @media (max-width:1000px){ .calc{ grid-template-columns:1fr; } .autocomplete{ right:18px; top:220px } .hint{ left:18px; top:200px } .side{ order:2 } .main{ order:1 } }
</style>
</head>
<body>

<div class="calc-wrap">
  <div class="calc" id="calc">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <div>
          <h1>Exam-Calc</h1>
          <small>human-crafted • gentle UI • fast math</small>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="openOnboarding" class="key sci" style="background:#6ea6c8;padding:8px 10px; font-weight:600"><i class="fas fa-book-open"></i> Quick start</button>
        <button id="showShortcuts" class="key sci" style="background:#9ecb8b;padding:8px 10px; font-weight:600"><i class="fas fa-keyboard"></i> Shortcuts</button>
      </div>
    </div>

    <!-- Main -->
    <div class="main" id="mainArea">
      <div class="display" id="displayArea">
        <div id="history">&nbsp;</div>
        <div id="preview">Type an expression — I'll preview it live ✨</div>
        <input id="display" type="text" disabled value="0" aria-label="Calculator display"/>
      </div>

      <div class="keys" id="keys" style="margin-top:14px">
        <!-- rows -->
        <div class="row">
          <button class="key clr" data-action="clear">AC</button>
          <button class="key clr" data-action="back">⌫</button>
          <button class="key sci" data-fn="sqrt">√</button>
          <button class="key sci" data-fn="pow">xⁿ</button>
          <button class="key op" data-val="/">÷</button>
          <button class="key mem" data-action="mc">MC</button>
          <button class="key sci" data-fn="nCr">nCr</button>
          <button class="key sci" data-fn="nPr">nPr</button>
        </div>

        <div class="row">
          <button class="key sci" data-fn="sin">sin</button>
          <button class="key sci" data-fn="cos">cos</button>
          <button class="key sci" data-fn="tan">tan</button>
          <button class="key sci" data-fn="asin">asin</button>
          <button class="key sci" data-fn="acos">acos</button>
          <button class="key mem" data-action="mr">MR</button>
          <button class="key sci" data-fn="sinh">sinh</button>
          <button class="key sci" data-fn="cosh">cosh</button>
        </div>

        <div class="row">
          <button class="key num" data-val="7">7</button>
          <button class="key num" data-val="8">8</button>
          <button class="key num" data-val="9">9</button>
          <button class="key op" data-val="*">×</button>
          <button class="key sci" data-fn="fact">x!</button>
          <button class="key mem" data-action="mplus">M+</button>
          <button class="key sci" data-fn="gcd">gcd</button>
          <button class="key sci" data-fn="lcm">lcm</button>
        </div>

        <div class="row">
          <button class="key num" data-val="4">4</button>
          <button class="key num" data-val="5">5</button>
          <button class="key num" data-val="6">6</button>
          <button class="key op" data-val="-">−</button>
          <button class="key sci" data-fn="abs">|x|</button>
          <button class="key mem" data-action="mminus">M-</button>
          <button class="key sci" data-fn="isprime">isPrime</button>
          <button class="key sci" data-fn="pfactor">pfactor</button>
        </div>

        <div class="row">
          <button class="key num" data-val="1">1</button>
          <button class="key num" data-val="2">2</button>
          <button class="key num" data-val="3">3</button>
          <button class="key op" data-val="+">+</button>
          <button class="key sci" data-fn="exp">eˣ</button>
          <button class="key sci" data-fn="rand">RND</button>
          <button class="key sci" data-fn="asinh">asinh</button>
          <button class="key sci" data-fn="tanh">tanh</button>
        </div>

        <div class="row">
          <button class="key num" data-val="0">0</button>
          <button class="key num" data-val=".">.</button>
          <button class="key op" data-val="(">(</button>
          <button class="key op" data-val=")">)</button>
          <button class="key eq" data-action="equals">=</button>
          <button class="key sci" data-fn="pi">π</button>
          <button class="key sci" data-fn="floor">floor</button>
          <button class="key sci" data-fn="ceil">ceil</button>
        </div>
      </div>
    </div>

    <!-- Side -->
    <aside class="side">
      <div class="sticky">
        <h4>Hello — here are a few tips</h4>
        <p>Try: <code>sin(30)</code>, <code>nCr(10,3)</code>, or <code>5!</code>. Use the Shortcuts button to see quick keys. Toggle notebook mode or export history below.</p>
      </div>

      <div>
        <strong style="display:block;margin-bottom:8px;color:#123447">History</strong>
        <div class="history-list" id="historyList" aria-live="polite"></div>
      </div>

      <div style="margin-top:8px">
        <strong style="display:block;margin-bottom:8px;color:#123447">Settings</strong>
        <div class="settings">
          <label>Angle mode <span style="float:right" id="angleLabel">DEG</span></label>
          <button id="angleToggle" class="key sci" style="padding:8px 10px;background:#9ecb8b">Deg / Rad</button>

          <label>Precision</label>
          <select id="precision" style="padding:8px;border-radius:8px"><option>6</option><option>4</option><option>2</option><option>0</option><option>12</option></select>

          <label>Notebook mode <small style="color:#666">(handwritten feel)</small></label>
          <button id="notebookToggle" class="key sci" style="background:#e0c68d;padding:8px">Toggle Notebook</button>

          <label>Sound (soft clicks)</label>
          <div style="display:flex;gap:8px">
            <button id="soundToggle" class="key sci" style="background:#c4d9ff;padding:8px">Toggle Sound</button>
            <button id="undoBtn" class="key" style="background:#d8d8d8;color:#002;padding:8px">Undo</button>
            <button id="redoBtn" class="key" style="background:#d8d8d8;color:#002;padding:8px">Redo</button>
          </div>

          <label style="margin-top:6px">Export</label>
          <div style="display:flex;gap:8px">
            <button id="exportTxt" class="key" style="background:#f3f3f3;color:#012;padding:8px">Download .txt</button>
            <button id="exportPng" class="key" style="background:#f3f3f3;color:#012;padding:8px">Export PNG</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Footer -->
    <div class="footer" style="grid-column:1 / -1">
      <div>Designed with care — a gentle calculator for real people.</div>
      <div style="opacity:.8">vHuman+ • 1.2</div>
    </div>
  </div>
</div>

<!-- floating UI widgets -->
<div class="autocomplete" id="autocomplete" role="listbox" aria-hidden="true"></div>
<div class="hint" id="argHint" aria-hidden="true"></div>
<div class="tooltip" id="tooltip" aria-hidden="true"></div>

<!-- Onboarding modal -->
<div class="modal-backdrop" id="onboardingModal" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Welcome to Exam-Calc</h2>
    <p>Nice to meet you 👋 — here's a quick tour:</p>
    <ul>
      <li>Type expressions like <code>sin(30)</code>, <code>5!</code>, or <code>nCr(10,3)</code>.</li>
      <li>Autocomplete & argument hints help you as you type.</li>
      <li>Use notebook mode for a paper-like feel.</li>
    </ul>
    <p style="margin-top:8px">Shortcuts: <strong>Enter</strong> = evaluate, <strong>Backspace</strong> = delete, type letters to trigger autocomplete.</p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="closeOnboarding" class="key sci" style="background:#9ecb8b;padding:8px 12px">Got it</button>
    </div>
  </div>
</div>

<!-- Shortcuts overlay -->
<div class="modal-backdrop" id="shortcutsModal" style="display:none">
  <div class="modal" role="dialog" aria-modal="true">
    <h2>Keyboard Shortcuts</h2>
    <ul>
      <li><strong>0–9</strong> type numbers</li>
      <li><strong>Enter</strong> evaluate</li>
      <li><strong>Backspace</strong> delete</li>
      <li><strong>Esc</strong> clear</li>
      <li><strong>Arrow Up / Down</strong> navigate autocomplete</li>
    </ul>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button id="closeShortcuts" class="key sci" style="background:#9ecb8b;padding:8px 12px">Close</button>
    </div>
  </div>
</div>

<script>
/* Human+ Calculator script
   - Adds onboarding, notebook mode, sounds, undo/redo, export txt/png, shortcuts overlay
   - Uses safe eval sandbox (same approach as before)
*/

(() => {
  // Elements
  const display = document.getElementById('display');
  const preview = document.getElementById('preview');
  const historyList = document.getElementById('historyList');
  const autocomplete = document.getElementById('autocomplete');
  const argHint = document.getElementById('argHint');
  const tooltip = document.getElementById('tooltip');
  const calc = document.getElementById('calc');
  const mainArea = document.getElementById('mainArea');
  const displayArea = document.getElementById('displayArea');

  // Buttons
  const openOnboarding = document.getElementById('openOnboarding');
  const onboardingModal = document.getElementById('onboardingModal');
  const closeOnboarding = document.getElementById('closeOnboarding');
  const showShortcuts = document.getElementById('showShortcuts');
  const shortcutsModal = document.getElementById('shortcutsModal');
  const closeShortcuts = document.getElementById('closeShortcuts');

  const angleToggle = document.getElementById('angleToggle');
  const angleLabel = document.getElementById('angleLabel');
  const precisionSel = document.getElementById('precision');
  const notebookToggle = document.getElementById('notebookToggle');
  const soundToggle = document.getElementById('soundToggle');
  const exportTxt = document.getElementById('exportTxt');
  const exportPng = document.getElementById('exportPng');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');

  // keys area
  const keys = document.getElementById('keys');

  // State
  let expr = '';
  let memory = parseFloat(localStorage.getItem('human_calc_memory') || '0') || 0;
  let history = JSON.parse(localStorage.getItem('human_calc_history') || '[]');
  let angleMode = localStorage.getItem('human_calc_angle') || 'deg';
  let precision = parseInt(localStorage.getItem('human_calc_precision') || '6', 10);
  let notebookMode = localStorage.getItem('human_calc_notebook') === '1';
  let soundEnabled = localStorage.getItem('human_calc_sound') === '1';
  let undoStack = [];
  let redoStack = [];
  let suggestions = [];
  let suggestionIndex = -1;

  // catalog
  const catalog = [
    {name:'sin', sig:'sin(x)', desc:'Sine — respects angle mode'},
    {name:'cos', sig:'cos(x)', desc:'Cosine'},
    {name:'tan', sig:'tan(x)', desc:'Tangent'},
    {name:'asin', sig:'asin(x)', desc:'Inverse sine'},
    {name:'acos', sig:'acos(x)', desc:'Inverse cosine'},
    {name:'atan', sig:'atan(x)', desc:'Inverse tangent'},
    {name:'sqrt', sig:'sqrt(x)', desc:'Square root'},
    {name:'pow', sig:'pow(a,b) or a^b', desc:'Power'},
    {name:'fact', sig:'fact(n) or n!', desc:'Factorial (integer)'},
    {name:'nCr', sig:'nCr(n,r)', desc:'Combinations'},
    {name:'nPr', sig:'nPr(n,r)', desc:'Permutations'},
    {name:'gcd', sig:'gcd(a,b)', desc:'Greatest common divisor'},
    {name:'lcm', sig:'lcm(a,b)', desc:'Least common multiple'},
    {name:'isprime', sig:'isprime(n)', desc:'Prime test (integer)'},
    {name:'pfactor', sig:'pfactor(n)', desc:'Prime factorization'},
    {name:'PI', sig:'PI', desc:'3.14159...'},
    {name:'E', sig:'E', desc:'2.71828...'},
    {name:'rand', sig:'rand()', desc:'Random number 0..1'},
    {name:'floor', sig:'floor(x)', desc:'Round down'},
    {name:'ceil', sig:'ceil(x)', desc:'Round up'}
  ];

  // helpers
  function pushUndo(s) { undoStack.push(s); if(undoStack.length > 200) undoStack.shift(); redoStack = []; updateUndoRedoButtons(); }
  function updateUndoRedoButtons() { undoBtn.disabled = undoStack.length === 0; redoBtn.disabled = redoStack.length === 0; }
  function fmt(v){ if(typeof v === 'number' && isFinite(v)){ if(precision===0) return String(Math.round(v)); return Number.parseFloat(v).toFixed(precision).replace(/\.?0+$/,''); } return String(v); }

  // math sandbox helpers
  function factorial(n){ const k=Math.floor(n); if(k<0||k!==n||k>170) throw 'Invalid factorial'; let r=1; for(let i=2;i<=k;i++) r*=i; return r; }
  function gcd(a,b){ a=Math.abs(Math.floor(a)); b=Math.abs(Math.floor(b)); if(!a) return b; if(!b) return a; while(b){ const t=b; b=a%b; a=t; } return a; }
  function lcm(a,b){ if(a===0||b===0) return 0; return Math.abs(Math.floor(a)/gcd(a,b)*Math.floor(b)); }
  function isPrimeSimple(n){ n=Math.floor(n); if(n<=1) return false; if(n<=3) return true; if(n%2===0) return false; const r=Math.floor(Math.sqrt(n)); for(let i=3;i<=r;i+=2) if(n%i===0) return false; return true; }
  function primeFactors(n){ n=Math.abs(Math.floor(n)); const out=[]; let d=2; while(d*d<=n){ while(n%d===0){ out.push(d); n/=d; } d=(d===2)?3:d+2; } if(n>1) out.push(n); return out; }

  function buildSandbox(){
    return {
      sin:x => angleMode==='deg' ? Math.sin(x*Math.PI/180) : Math.sin(x),
      cos:x => angleMode==='deg' ? Math.cos(x*Math.PI/180) : Math.cos(x),
      tan:x => angleMode==='deg' ? Math.tan(x*Math.PI/180) : Math.tan(x),
      asin:x => angleMode==='deg' ? Math.asin(x)*180/Math.PI : Math.asin(x),
      acos:x => angleMode==='deg' ? Math.acos(x)*180/Math.PI : Math.acos(x),
      atan:x => angleMode==='deg' ? Math.atan(x)*180/Math.PI : Math.atan(x),
      sqrt: x => Math.sqrt(x),
      pow: (a,b) => Math.pow(a,b),
      abs: x => Math.abs(x),
      exp: x => Math.exp(x),
      rand: () => Math.random(),
      PI: Math.PI, E: Math.E,
      fact: factorial,
      nCr: (n,r) => { n=Math.floor(n); r=Math.floor(r); if(r<0||n<0||r>n) return 0; if(r>n-r) r=n-r; let num=1,den=1; for(let i=1;i<=r;i++){ num*=(n-r+i); den*=i; } return Math.round(num/den); },
      nPr: (n,r) => { n=Math.floor(n); r=Math.floor(r); if(r<0||n<0||r>n) return 0; let res=1; for(let i=0;i<r;i++) res*=(n-i); return res; },
      gcd: (a,b)=>gcd(a,b), lcm:(a,b)=>lcm(a,b),
      isprime: (n)=>isPrimeSimple(n), pfactor:(n)=>primeFactors(n),
      floor:x=>Math.floor(x), ceil:x=>Math.ceil(x), round:x=>Math.round(x)
    };
  }

  function preprocess(s){
    s = s.replace(/\s+/g,'');
    const re = /(\d+(\.\d+)?|\([^()]*\))!/;
    while(re.test(s)) s = s.replace(re, 'fact($1)');
    s = s.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
    s = s.replace(/([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))\^([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))/g, 'pow($1,$3)');
    return s;
  }

  function evaluateExpression(input){
    if(!input || input.trim()==='') return '';
    try{
      const processed = preprocess(input);
      const sb = buildSandbox();
      const keys = Object.keys(sb);
      const args = keys.map(k => sb[k]);
      const fn = new Function(...keys, 'return (' + processed + ');');
      const result = fn(...args);
      return result;
    } catch(e){
      return 'Error';
    }
  }

  // UI updates
  function renderDisplay(){ display.value = expr || '0'; document.getElementById('history').textContent = history.length ? history[history.length-1].expr + ' =' : '\u00A0'; }
  function renderHistoryList(){ historyList.innerHTML = ''; if(!history.length){ historyList.innerHTML = '<div style="padding:10px;color:#456">No history yet.</div>'; return; } for(let i = history.length - 1; i >= 0; i--){ const it = history[i]; const el = document.createElement('div'); el.className = 'history-item'; el.innerHTML = `<div style="flex:1"><strong>${it.expr}</strong><div style="font-size:0.85rem;color:#667">${fmt(it.result)}</div></div><div style="display:flex;gap:6px"><button data-load="${i}">Load</button><button data-copy="${i}">Copy</button></div>`; historyList.appendChild(el); } }
  function saveState(){ localStorage.setItem('human_calc_history', JSON.stringify(history)); localStorage.setItem('human_calc_memory', String(memory)); localStorage.setItem('human_calc_angle', angleMode); localStorage.setItem('human_calc_precision', String(precision)); localStorage.setItem('human_calc_notebook', notebookMode ? '1' : '0'); localStorage.setItem('human_calc_sound', soundEnabled ? '1' : '0'); }

  // Undo/Redo handlers
  undoBtn.addEventListener('click', () => { if(undoStack.length){ redoStack.push(expr); expr = undoStack.pop(); renderDisplay(); schedulePreview(); updateUndoRedoButtons(); } });
  redoBtn.addEventListener('click', () => { if(redoStack.length){ undoStack.push(expr); expr = redoStack.pop(); renderDisplay(); schedulePreview(); updateUndoRedoButtons(); } });
  function updateUndoRedoButtons(){ undoBtn.disabled = undoStack.length === 0; redoBtn.disabled = redoStack.length === 0; }

  // Sound
  let audioCtx = null;
  function clickSound(){
    if(!soundEnabled) return;
    try{
      if(!audioCtx){ audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
      g.gain.setValueAtTime(0, audioCtx.currentTime);
      g.gain.linearRampToValueAtTime(0.04, audioCtx.currentTime + 0.001);
      g.gain.linearRampToValueAtTime(0.0001, audioCtx.currentTime + 0.09);
      o.connect(g); g.connect(audioCtx.destination); o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.1);
    } catch(e){}
  }

  // Autocomplete fuzzy substring
  function updateAutocomplete(){
    const m = expr.match(/[A-Za-z_]+$/);
    const token = m?m[0]:'';
    if(!token){ hideAutocomplete(); hideArgHint(); return; }
    const low = token.toLowerCase();
    suggestions = catalog.filter(c => c.name.toLowerCase().includes(low)).slice(0,10);
    suggestionIndex = suggestions.length ? 0 : -1;
    renderAutocomplete();
    updateArgHint();
  }
  function renderAutocomplete(){
    autocomplete.innerHTML = '';
    if(!suggestions.length){ autocomplete.style.display = 'none'; autocomplete.setAttribute('aria-hidden','true'); return; }
    suggestions.forEach((s,i) => {
      const div = document.createElement('div');
      div.className = 'suggest';
      div.dataset.index = i;
      div.innerHTML = `<div><strong>${s.name}</strong><div style="font-size:0.85rem;color:#9fd3ff">${s.desc}</div></div><div style="opacity:0.8">${s.sig||''}</div>`;
      div.addEventListener('click', ()=> acceptSuggestion(i));
      div.addEventListener('mousemove', e => { showTooltip((s.sig || s.name) + ' — ' + s.desc, e.clientX+8, e.clientY+8); });
      div.addEventListener('mouseleave', hideTooltip);
      autocomplete.appendChild(div);
    });
    autocomplete.style.display = 'block'; autocomplete.setAttribute('aria-hidden','false');
  }
  function hideAutocomplete(){ autocomplete.style.display = 'none'; autocomplete.setAttribute('aria-hidden','true'); suggestions=[]; suggestionIndex=-1; }
  function acceptSuggestion(i){
    if(i<0 || i>=suggestions.length) return;
    const s = suggestions[i];
    const tokenMatch = expr.match(/[A-Za-z_]+$/);
    if(tokenMatch) expr = expr.slice(0, -tokenMatch[0].length);
    expr += (s.sig && s.name !== 'PI' && s.name !== 'E') ? s.name + '(' : s.name;
    pushUndo(expr);
    renderDisplay(); hideAutocomplete(); schedulePreview();
  }

  // argument hint
  function updateArgHint(){
    const m = expr.match(/([A-Za-z_]\w*)\([^()]*$/);
    if(!m){ argHint.style.display = 'none'; return; }
    const name = m[1];
    const entry = catalog.find(c => c.name === name);
    if(!entry){ argHint.style.display = 'none'; return; }
    argHint.innerHTML = `<strong>${entry.sig}</strong><div style="font-size:0.9rem;color:#274b4f">${entry.desc}</div>`;
    argHint.style.display = 'block';
  }
  function hideArgHint(){ argHint.style.display = 'none'; }

  // preview (debounced)
  let previewTimer = null;
  function schedulePreview(){
    if(previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(()=> {
      const v = evaluateExpression(expr);
      preview.textContent = (v==='Error' || v==='' ? '…' : '≈ ' + fmt(v));
    }, 120);
  }

  // tooltip
  function showTooltip(text,x,y){ tooltip.textContent = text; tooltip.style.left = (x+8)+'px'; tooltip.style.top = (y+8)+'px'; tooltip.style.display = 'block'; }
  function hideTooltip(){ tooltip.style.display = 'none'; }

  // button clicks
  keys.addEventListener('click', e => {
    const btn = e.target.closest('.key');
    if(!btn) return;
    clickSound();
    btn.classList.add('anim'); setTimeout(()=>btn.classList.remove('anim'),220);
    const val = btn.getAttribute('data-val');
    const action = btn.getAttribute('data-action');
    const fn = btn.getAttribute('data-fn');

    if(val){ pushUndo(expr); expr += val; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if(fn){
      pushUndo(expr);
      if(!expr){
        if(fn==='pi') expr += 'PI';
        else if(fn==='rand') expr += 'rand()';
        else expr += fn + '(';
      } else {
        if(['fact','rand','pi','isprime','pfactor'].includes(fn)){
          if(fn==='fact') expr = 'fact(' + expr + ')';
          else if(fn==='rand') expr = 'rand()';
          else if(fn==='pi') expr += 'PI';
          else if(fn==='isprime') expr = 'isprime(' + expr + ')';
          else if(fn==='pfactor') expr = 'pfactor(' + expr + ')';
        } else if(fn==='pow'){ expr += '^'; }
        else { expr = fn + '(' + expr + ')'; }
      }
      renderDisplay(); schedulePreview(); updateAutocomplete(); updateArgHint(); return;
    }
    if(action){
      switch(action){
        case 'clear': pushUndo(expr); expr=''; renderDisplay(); preview.textContent = "Type an expression — I'll preview it live ✨"; hideAutocomplete(); hideArgHint(); break;
        case 'back': pushUndo(expr); expr = expr.slice(0,-1); renderDisplay(); schedulePreview(); updateAutocomplete(); updateArgHint(); break;
        case 'equals': {
          const v = evaluateExpression(expr);
          if(v !== 'Error' && v !== '' && v !== undefined){ history.push({expr: expr, result: v}); if(history.length>400) history.shift(); saveState(); expr = String(v); renderHistoryList(); preview.textContent = ''; } else { preview.textContent = 'Error'; }
          renderDisplay(); hideAutocomplete(); hideArgHint(); break;
        }
        case 'mc': memory = 0; saveState(); break;
        case 'mr': pushUndo(expr); expr += String(memory); renderDisplay(); schedulePreview(); updateAutocomplete(); break;
        case 'mplus': { const v = evaluateExpression(expr); if(typeof v==='number' && isFinite(v)) memory += v; saveState(); break; }
        case 'mminus': { const v = evaluateExpression(expr); if(typeof v==='number' && isFinite(v)) memory -= v; saveState(); break; }
      }
    }
  });

  // history load/copy
  historyList.addEventListener('click', e => {
    const load = e.target.getAttribute('data-load');
    const copy = e.target.getAttribute('data-copy');
    if(load !== null){ const it = history[load]; if(it){ pushUndo(expr); expr = it.expr; renderDisplay(); schedulePreview(); } }
    if(copy !== null){ const it = history[copy]; if(it) navigator.clipboard?.writeText(String(it.result)).catch(()=>{}); }
  });

  // keyboard
  document.addEventListener('keydown', e => {
    if(autocomplete.style.display === 'block'){
      if(e.key === 'ArrowDown'){ e.preventDefault(); suggestionIndex = (suggestionIndex + 1) % suggestions.length; renderAutocompleteCursor(); return; }
      if(e.key === 'ArrowUp'){ e.preventDefault(); suggestionIndex = (suggestionIndex - 1 + suggestions.length) % suggestions.length; renderAutocompleteCursor(); return; }
      if(e.key === 'Enter'){ if(suggestionIndex >= 0){ acceptSuggestion(suggestionIndex); e.preventDefault(); return; } }
      if(e.key === 'Escape'){ hideAutocomplete(); hideArgHint(); return; }
    }
    if(e.key >= '0' && e.key <= '9'){ pushUndo(expr); expr += e.key; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if(e.key === '.') { pushUndo(expr); expr += '.'; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if('+-*/%^()'.includes(e.key)){ pushUndo(expr); expr += e.key; renderDisplay(); schedulePreview(); updateArgHint(); return; }
    if(e.key === 'Enter'){ document.querySelector('[data-action="equals"]').click(); return; }
    if(e.key === 'Backspace'){ document.querySelector('[data-action="back"]').click(); return; }
    if(e.key === 'Escape'){ document.querySelector('[data-action="clear"]').click(); return; }
    if(/^[a-zA-Z]$/.test(e.key)){ pushUndo(expr); expr += e.key; renderDisplay(); updateAutocomplete(); schedulePreview(); return; }
    if(e.key === '!'){ pushUndo(expr); expr += '!'; renderDisplay(); schedulePreview(); return; }
  });

  function renderAutocompleteCursor(){
    const children = Array.from(autocomplete.children);
    children.forEach((c, i) => c.style.background = (i===suggestionIndex? 'rgba(255,255,255,0.04)':'transparent'));
  }

  // autocompile helpers
  function renderAutocomplete(){
    autocomplete.innerHTML = '';
    if(!suggestions.length){ hideAutocomplete(); return; }
    suggestions.forEach((s,i) => {
      const div = document.createElement('div');
      div.className = 'suggest';
      div.dataset.index = i;
      div.innerHTML = `<div><strong>${s.name}</strong><div style="font-size:0.85rem;color:#9fd3ff">${s.desc}</div></div><div style="opacity:0.8">${s.sig||''}</div>`;
      div.addEventListener('click', ()=> acceptSuggestion(i));
      div.addEventListener('mousemove', e => showTooltip((s.sig || s.name) + ' — ' + s.desc, e.clientX+8, e.clientY+8));
      div.addEventListener('mouseleave', hideTooltip);
      autocomplete.appendChild(div);
    });
    autocomplete.style.display = 'block';
    suggestionIndex = Math.max(0, suggestionIndex);
    renderAutocompleteCursor();
  }

  function hideAutocomplete(){ autocomplete.style.display = 'none'; suggestions=[]; suggestionIndex=-1; autocomplete.setAttribute('aria-hidden','true'); }

  function acceptSuggestion(i){
    if(i<0 || i>=suggestions.length) return;
    const s = suggestions[i];
    const tokenMatch = expr.match(/[A-Za-z_]+$/);
    if(tokenMatch) expr = expr.slice(0, -tokenMatch[0].length);
    expr += (s.sig && s.name !== 'PI' && s.name !== 'E') ? s.name + '(' : s.name;
    pushUndo(expr);
    renderDisplay(); hideAutocomplete(); schedulePreview(); updateArgHint();
  }

  // fuzzy suggestions trigger
  function updateAutocomplete(){
    const m = expr.match(/[A-Za-z_]+$/); const token = m? m[0] : '';
    if(!token){ hideAutocomplete(); hideArgHint(); return; }
    const low = token.toLowerCase();
    suggestions = catalog.filter(c => c.name.toLowerCase().includes(low)).slice(0,10);
    suggestionIndex = suggestions.length ? 0 : -1;
    renderAutocomplete();
    updateArgHint();
  }

  // arg hint
  function updateArgHint(){
    const m = expr.match(/([A-Za-z_]\w*)\([^()]*$/);
    if(!m){ argHint.style.display = 'none'; return; }
    const name = m[1]; const entry = catalog.find(c => c.name === name);
    if(!entry){ argHint.style.display = 'none'; return; }
    argHint.innerHTML = `<strong>${entry.sig}</strong><div style="font-size:0.9rem;color:#274b4f">${entry.desc}</div>`;
    argHint.style.display = 'block';
  }

  // Onboarding modal
  openOnboarding.addEventListener('click', ()=> { onboardingModal.style.display = 'flex'; });
  closeOnboarding.addEventListener('click', ()=> { onboardingModal.style.display = 'none'; });

  // Shortcuts modal
  showShortcuts.addEventListener('click', ()=> { shortcutsModal.style.display = 'flex'; });
  closeShortcuts.addEventListener('click', ()=> { shortcutsModal.style.display = 'none'; });

  // Settings actions
  document.getElementById('angleToggle').addEventListener('click', () => {
    angleMode = angleMode === 'deg' ? 'rad' : 'deg';
    angleLabel.textContent = angleMode.toUpperCase();
    localStorage.setItem('human_calc_angle', angleMode);
    schedulePreview();
  });
  precisionSel.addEventListener('change', () => {
    precision = parseInt(precisionSel.value || '6', 10); localStorage.setItem('human_calc_precision', String(precision)); schedulePreview();
  });

  notebookToggle.addEventListener('click', () => {
    notebookMode = !notebookMode; if(notebookMode) document.body.classList.add('notebook-mode'); else document.body.classList.remove('notebook-mode');
    localStorage.setItem('human_calc_notebook', notebookMode ? '1' : '0');
  });

  soundToggle.addEventListener('click', () => {
    soundEnabled = !soundEnabled; localStorage.setItem('human_calc_sound', soundEnabled ? '1' : '0');
    soundToggle.style.opacity = soundEnabled ? '1' : '0.65';
  });

  // Export history .txt
  exportTxt.addEventListener('click', () => {
    let text = 'Exam-Calc History\n';
    text += '-----------------\n';
    history.forEach(h => { text += `${h.expr} = ${fmt(h.result)}\n`; });
    const blob = new Blob([text], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'exam-calc-history.txt'; a.click(); URL.revokeObjectURL(a.href);
  });

  // Export PNG using SVG foreignObject -> canvas
  exportPng.addEventListener('click', async () => {
    try{
      // capture the main calc element (calc-wrap)
      const node = document.querySelector('.calc');
      const rect = node.getBoundingClientRect();
      const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${rect.width}' height='${rect.height}'>
        <foreignObject width='100%' height='100%'>
          ${new XMLSerializer().serializeToString(node)}
        </foreignObject>
      </svg>`;
      const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = rect.width * devicePixelRatio;
        canvas.height = rect.height * devicePixelRatio;
        const ctx = canvas.getContext('2d');
        ctx.scale(devicePixelRatio, devicePixelRatio);
        ctx.drawImage(img, 0, 0);
        canvas.toBlob(b => {
          const a = document.createElement('a'); a.download = 'exam-calc.png'; a.href = URL.createObjectURL(b); a.click(); URL.revokeObjectURL(a.href);
        }, 'image/png');
        URL.revokeObjectURL(url);
      };
      img.onerror = () => { alert('Export failed (browser limitation). Try using the Download .txt option or take a screenshot.'); URL.revokeObjectURL(url); };
      img.src = url;
    } catch (e) {
      alert('Export failed: ' + (e && e.message ? e.message : 'unknown error'));
    }
  });

  // Restore saved options
  function restore() {
    display.value = '0';
    angleLabel.textContent = angleMode.toUpperCase();
    precisionSel.value = String(precision);
    if(localStorage.getItem('human_calc_notebook') === '1'){ notebookMode = true; document.body.classList.add('notebook-mode'); }
    if(localStorage.getItem('human_calc_sound') === '1'){ soundEnabled = true; }
    renderHistoryList();
  }

  // Init
  restore();

  // Start UI
  renderDisplay();
  updateUndoRedoButtons();

  // Expose some debug
  window.examCalc = { evaluate: evaluateExpression, getState: ()=> ({expr,history,memory,angleMode,precision}) };

})();
</script>
</body>
</html>
