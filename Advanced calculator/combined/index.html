<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Exam-Calc ‚Äî Enhanced Pro</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<script>
window.MathJax={
  loader:{load:['input/tex','output/svg']},
  tex:{inlineMath:[['$','$'],['\\(','\\)']],macros:{RR:'\\mathbb{R}',bold:['{\\bf #1}',1]}},
  svg:{font:'STIX-Web',scale:1},
  options:{renderActions:{addMenu:[]}}
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg-1:#f3f6f9;--bg-2:#eef3f7;--panel:#223244;--accent:#f6b042;--muted:#90a4ae;
  --radius:12px;--shadow-1:0 10px 30px rgba(34,50,68,.12);--math-color:#123447;
  --blur:blur(8px);--ease:cubic-bezier(.22,1,.36,1);
  --success:#10b981;--warning:#f59e0b;--error:#ef4444;--info:#3b82f6;
}
@media (prefers-color-scheme:dark){
  :root{--bg-1:#0d1117;--bg-2:#11151d;--panel:#161b22;--accent:#ffa94d;--muted:#6e7681;--math-color:#c9d1d9}
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));font-family:'Inter',system-ui,Arial,sans-serif;color:var(--math-color);-webkit-font-smoothing:antialiased}
body{display:flex;align-items:center;justify-content:center;padding:16px}
.calc-wrap{width:96vw;max-width:1200px}
.calc{background:rgba(255,255,255,.55);border-radius:var(--radius);box-shadow:var(--shadow-1);display:grid;grid-template-columns:1fr 450px;gap:14px;padding:14px;backdrop-filter:var(--blur);-webkit-backdrop-filter:var(--blur);border:1px solid rgba(255,255,255,.18);transition:background .25s var(--ease)}
@media (prefers-color-scheme:dark){.calc{background:rgba(22,27,34,.55);border-color:rgba(255,255,255,.06)}}
.header{grid-column:1/-1;display:flex;justify-content:space-between;align-items:center;padding:6px 10px;border-bottom:1px solid rgba(0,0,0,.05);margin-bottom:10px}
.brand h1{font-family:'Patrick Hand',cursive;margin:0;font-size:1.6rem;background:linear-gradient(135deg, var(--accent), #e67e22);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.brand small{display:block;color:var(--muted);font-size:.78rem;margin-top:2px}
.controls{display:flex;gap:8px;align-items:center}
.main{background:rgba(255,255,255,.6);border-radius:10px;padding:12px;min-height:620px;position:relative;display:flex;flex-direction:column}
.display{background:rgba(251,253,255,.8);border-radius:10px;padding:12px;border:1px solid rgba(3,17,28,.04);box-shadow:inset 0 2px 8px rgba(16,40,60,.03);position:relative}
#history{font-size:.9rem;color:var(--muted);text-align:right;min-height:20px;margin-bottom:6px;padding-right:6px}
#preview{min-height:20px;margin-top:6px;font-size:.92rem;text-align:right;color:var(--accent);font-weight:600}
#display{width:100%;height:68px;border-radius:10px;border:1px solid rgba(3,17,28,.06);padding:10px 12px;font-size:1.6rem;font-weight:700;text-align:right;background:transparent;color:inherit;outline:2px solid transparent;transition:all .2s var(--ease)}
#display:focus{outline:2px solid var(--accent);box-shadow:0 0 0 3px rgba(246,176,66,.1)}
.keys{margin-top:10px;display:grid;gap:10px}
.row{display:grid;grid-template-columns:repeat(8,1fr);gap:8px}
.key{border-radius:8px;padding:8px 6px;cursor:pointer;border:none;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden;transition:transform .12s,box-shadow .2s;box-shadow:0 2px 4px rgba(0,0,0,.1)}
.key:hover{box-shadow:0 4px 8px rgba(0,0,0,.15)}
.key:active{transform:translateY(1px)}
.num{background:linear-gradient(180deg,#7d8a91,#6b7880)}.op{background:linear-gradient(180deg,#f39c12,#d35400)}.eq{background:linear-gradient(180deg,#27ae60,#188c43)}.clr{background:linear-gradient(180deg,#e74c3c,#c0392b)}.sci{background:linear-gradient(180deg,#3498db,#2e7bb9)}.mem{background:linear-gradient(180deg,#9b59b6,#8b3fb0)}
.side{background:rgba(255,255,255,.6);border-radius:10px;padding:10px;min-height:620px;display:flex;flex-direction:column;gap:10px}
.sticky{background:linear-gradient(180deg,#fffdf6,#fff9ec);border-radius:8px;padding:10px;color:#5b3b00;border-left:4px solid var(--accent)}
.history-list{max-height:300px;overflow:auto;padding:6px;border-radius:8px;background:rgba(251,253,255,.6);border:1px dashed rgba(3,17,28,.03)}
.history-item{padding:8px;border-bottom:1px solid rgba(3,17,28,.04);display:flex;justify-content:space-between;gap:8px;align-items:center;transition:background .2s}
.history-item:hover{background:rgba(0,0,0,.03)}
.autocomplete{position:absolute;right:100px;top:140px;min-width:320px;background:rgba(12,20,26,.95);color:#fff;border-radius:8px;padding:6px;display:none;z-index:150;max-height:320px;overflow:auto;border:1px solid rgba(255,255,255,.06);box-shadow:0 10px 25px rgba(0,0,0,.2)}
.autocomplete .suggest{padding:8px;border-radius:8px;cursor:pointer;display:flex;justify-content:space-between;gap:8px;align-items:center;transition:background .15s}
.autocomplete .suggest:hover{background:rgba(255,255,255,.1)}
.hint{position:absolute;left:18px;top:140px;min-width:260px;background:#f6fffb;color:#0b3b3a;padding:10px;border-radius:8px;display:none;border-left:4px solid var(--success);z-index:100}
.tooltip{position:fixed;pointer-events:none;padding:8px 10px;border-radius:8px;background:#0f1720;color:#fff;font-size:.87rem;display:none;z-index:1000;max-width:300px}
.status-bar{display:flex;justify-content:space-between;margin-top:10px;font-size:.8rem;color:var(--muted)}
.settings{display:flex;flex-direction:column;gap:6px;padding:8px;border-radius:8px;border:1px solid rgba(3,17,28,.03)}
.modal-backdrop{position:fixed;inset:0;background:rgba(6,10,12,.45);display:none;align-items:center;justify-content:center;z-index:200}
.modal{background:#fff;padding:18px;border-radius:10px;width:720px;max-width:94vw;box-shadow:0 20px 60px rgba(0,0,0,.2)}
.footer{grid-column:1/-1;padding-top:8px;display:flex;justify-content:space-between;color:var(--muted);font-size:.85rem;border-top:1px solid rgba(0,0,0,.05);margin-top:10px}
.notebook-mode #display{font-family:'Patrick Hand',cursive}
.ripple{position:absolute;border-radius:50%;background:rgba(255,255,255,.7);transform:scale(0);animation:ripple .6s linear}
@keyframes ripple{to{transform:scale(4);opacity:0}}
.tab-container{margin-top:10px}
.tabs{display:flex;border-bottom:1px solid rgba(0,0,0,.1)}
.tab{flex:1;padding:8px;text-align:center;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s}
.tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.tab-content{display:none;padding:10px 0}
.tab-content.active{display:block}
@media (max-width:900px){.calc{grid-template-columns:1fr}.autocomplete{right:18px;top:220px}.hint{left:18px;top:200px}.row{grid-template-columns:repeat(4,1fr)}.side{order:2}.main{order:1}}
</style>
</head>

<body>
<div class="calc-wrap">
  <div class="calc" id="calc">
    <div class="header">
      <div class="brand"><div><h1>Exam-Calc Pro</h1><small>enhanced ‚Äî safer eval, more units, accessibility</small></div></div>
      <div class="controls">
        <button id="openOnboarding" class="key sci" aria-label="Quick start">üìò Quick start</button>
        <button id="showShortcuts" class="key sci" aria-label="Shortcuts">‚å®Ô∏è Shortcuts</button>
        <button id="darkToggle" class="key" aria-pressed="false" title="Toggle dark background">üåô</button>
      </div>
    </div>

    <div class="main" id="mainArea">
      <div class="display" id="displayArea">
        <div id="history" aria-hidden="true">&nbsp;</div>
        <div id="preview" aria-live="polite">Type an expression or conversion ‚Äî suggestions will appear while you type.</div>
        <input id="display" type="text" value="0" aria-label="Calculator display" autocomplete="off"/>
        <div id="validationMessage" class="hint" style="display:none" aria-live="assertive"></div>
      </div>

      <div class="status-bar">
        <div id="memoryStatus">Memory: 0</div>
        <div id="angleStatus">Angle: DEG</div>
        <div id="precisionStatus">Precision: 6</div>
      </div>

      <div class="keys" id="keys" style="margin-top:12px">
        <!-- rows (kept same layout) -->
        <div class="row">
          <button class="key clr" data-action="clear">AC</button>
          <button class="key clr" data-action="back">‚å´</button>
          <button class="key sci" data-fn="sqrt">‚àö</button>
          <button class="key sci" data-fn="pow">x‚Åø</button>
          <button class="key op" data-val="/">√∑</button>
          <button class="key mem" data-action="mc">MC</button>
          <button class="key sci" data-fn="nCr">nCr</button>
          <button class="key sci" data-fn="nPr">nPr</button>
        </div>
        <div class="row">
          <button class="key sci" data-fn="sin">sin</button>
          <button class="key sci" data-fn="cos">cos</button>
          <button class="key sci" data-fn="tan">tan</button>
          <button class="key sci" data-fn="asin">asin</button>
          <button class="key sci" data-fn="acos">acos</button>
          <button class="key mem" data-action="mr">MR</button>
          <button class="key sci" data-fn="sinh">sinh</button>
          <button class="key sci" data-fn="cosh">cosh</button>
        </div>
        <div class="row">
          <button class="key num" data-val="7">7</button>
          <button class="key num" data-val="8">8</button>
          <button class="key num" data-val="9">9</button>
          <button class="key op" data-val="*">√ó</button>
          <button class="key sci" data-fn="fact">x!</button>
          <button class="key mem" data-action="mplus">M+</button>
          <button class="key sci" data-fn="gcd">gcd</button>
          <button class="key sci" data-fn="lcm">lcm</button>
        </div>
        <div class="row">
          <button class="key num" data-val="4">4</button>
          <button class="key num" data-val="5">5</button>
          <button class="key num" data-val="6">6</button>
          <button class="key op" data-val="-">‚àí</button>
          <button class="key sci" data-fn="abs">|x|</button>
          <button class="key mem" data-action="mminus">M-</button>
          <button class="key sci" data-fn="isprime">isPrime</button>
          <button class="key sci" data-fn="pfactor">pfactor</button>
        </div>
        <div class="row">
          <button class="key num" data-val="1">1</button>
          <button class="key num" data-val="2">2</button>
          <button class="key num" data-val="3">3</button>
          <button class="key op" data-val="+">+</button>
          <button class="key sci" data-fn="exp">eÀ£</button>
          <button class="key sci" data-fn="rand">RND</button>
          <button class="key sci" data-fn="asinh">asinh</button>
          <button class="key sci" data-fn="tanh">tanh</button>
        </div>
        <div class="row">
          <button class="key num" data-val="0">0</button>
          <button class="key num" data-val="." aria-label="decimal">.</button>
          <button class="key op" data-val="(">(</button>
          <button class="key op" data-val=")">)</button>
          <button class="key eq" data-action="equals">=</button>
          <button class="key sci" data-fn="pi">œÄ</button>
          <button class="key sci" data-fn="floor">floor</button>
          <button class="key sci" data-fn="ceil">ceil</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <input id="unitInput" placeholder="Try: 10 km to m" style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(3,17,28,.06)" aria-label="unit convert"/>
          <button id="convertBtn" class="key sci">Convert</button>
        </div>

      </div>
    </div>

    <aside class="side">
      <div class="sticky"><h4>Quick tips</h4>
        <p>Type <code>sin(30)</code>, <code>5!</code> or <code>10 km to m</code>. Press <strong>Enter</strong> to evaluate. Use the unit box or type directly.</p>
      </div>

      <div class="tab-container">
        <div class="tabs">
          <div class="tab active" data-tab="history">History</div>
          <div class="tab" data-tab="constants">Constants</div>
          <div class="tab" data-tab="formulas">Formulas</div>
        </div>
        
        <div class="tab-content active" id="history-tab">
          <div style="display:flex;gap:8px;margin-top:6px;margin-bottom:6px">
            <button id="clearHistory" class="key clr" style="padding:6px">Clear</button>
            <button id="copyHistory" class="key" style="padding:6px">Copy All</button>
          </div>
          <div class="history-list" id="historyList" aria-live="polite"></div>
        </div>
        
        <div class="tab-content" id="constants-tab">
          <div class="history-list">
            <div class="history-item">
              <div><strong>œÄ</strong> (pi)</div>
              <div>3.1415926535</div>
            </div>
            <div class="history-item">
              <div><strong>e</strong> (Euler's number)</div>
              <div>2.7182818284</div>
            </div>
            <div class="history-item">
              <div><strong>g</strong> (gravity)</div>
              <div>9.80665 m/s¬≤</div>
            </div>
            <div class="history-item">
              <div><strong>c</strong> (light speed)</div>
              <div>299792458 m/s</div>
            </div>
          </div>
        </div>
        
        <div class="tab-content" id="formulas-tab">
          <div class="history-list">
            <div class="history-item">
              <div><strong>Quadratic Formula</strong></div>
              <div>x = (-b ¬± ‚àö(b¬≤-4ac))/2a</div>
            </div>
            <div class="history-item">
              <div><strong>Pythagorean Theorem</strong></div>
              <div>a¬≤ + b¬≤ = c¬≤</div>
            </div>
            <div class="history-item">
              <div><strong>Area of Circle</strong></div>
              <div>A = œÄr¬≤</div>
            </div>
            <div class="history-item">
              <div><strong>Volume of Sphere</strong></div>
              <div>V = (4/3)œÄr¬≥</div>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:8px">
        <strong>Settings</strong>
        <div class="settings">
          <label>Angle mode <span style="float:right" id="angleLabel">DEG</span></label>
          <button id="angleToggle" class="key sci">Deg / Rad</button>

          <label>Precision</label>
          <select id="precision" style="padding:8px;border-radius:8px"><option>6</option><option>4</option><option>2</option><option>0</option><option>12</option></select>

          <label>Notebook mode</label>
          <button id="notebookToggle" class="key sci">Toggle Notebook</button>

          <label>Sound</label>
          <div style="display:flex;gap:6px">
            <select id="soundTheme" style="padding:8px;border-radius:8px"><option value="none">Off</option><option value="bell">Bell</option><option value="tap">Tap</option><option value="pop">Pop</option></select>
            <button id="testSound" class="key">Test</button>
          </div>

          <label style="margin-top:6px">Export</label>
          <div style="display:flex;gap:8px">
            <button id="exportTxt" class="key">.txt</button>
            <button id="exportPng" class="key">PNG</button>
            <button id="exportPdf" class="key">PDF</button>
          </div>
        </div>
      </div>
    </aside>

    <div class="footer"><div>Made for learners</div><div style="opacity:.8">vEnhanced Pro ‚Ä¢ 3.3</div></div>
  </div>
</div>

<div class="autocomplete" id="autocomplete" role="listbox" aria-hidden="true"></div>
<div class="hint" id="argHint" aria-hidden="true"></div>
<div class="tooltip" id="tooltip" aria-hidden="true"></div>

<!-- modals -->
<div class="modal-backdrop" id="onboardingModal"><div class="modal" role="dialog"><h2>Welcome to Exam-Calc Pro</h2><p>Try typing <code>10 km to m</code> or <code>sin(30)</code>. Use Enter to evaluate. Autocomplete appears when typing functions or "to" conversions.</p><p>Check out the Constants and Formulas tabs for quick reference.</p><div style="text-align:right;margin-top:12px"><button id="closeOnboarding" class="key">Close</button></div></div></div>
<div class="modal-backdrop" id="shortcutsModal"><div class="modal" role="dialog"><h2>Keyboard Shortcuts</h2><ul><li>Enter = evaluate</li><li>Esc = clear</li><li>Up/Down = autocomplete</li><li>Ctrl+M = toggle memory</li><li>Ctrl+D = toggle dark mode</li></ul><div style="text-align:right;margin-top:12px"><button id="closeShortcuts" class="key">Close</button></div></div></div>

<script>
(()=>{
  const $=q=>document.querySelector(q),$$=q=>[...document.querySelectorAll(q)];
  const display=$('#display'),preview=$('#preview'),historyList=$('#historyList'),autocomplete=$('#autocomplete'),argHint=$('#argHint'),tooltip=$('#tooltip');
  const openOnboarding=$('#openOnboarding'),onboardingModal=$('#onboardingModal'),closeOnboarding=$('#closeOnboarding'),showShortcuts=$('#showShortcuts'),shortcutsModal=$('#shortcutsModal'),closeShortcuts=$('#closeShortcuts');
  const angleToggle=$('#angleToggle'),angleLabel=$('#angleLabel'),precisionSelect=$('#precision'),notebookToggle=$('#notebookToggle'),soundTheme=$('#soundTheme'),testSound=$('#testSound');
  const exportTxt=$('#exportTxt'),exportPng=$('#exportPng'),exportPdf=$('#exportPdf'),unitInput=$('#unitInput'),convertBtn=$('#convertBtn');
  const clearHistoryBtn=$('#clearHistory'),copyHistoryBtn=$('#copyHistory'),darkToggle=$('#darkToggle');
  const memoryStatus=$('#memoryStatus'),angleStatus=$('#angleStatus'),precisionStatus=$('#precisionStatus');
  const tabs=$$('.tab'),tabContents=$$('.tab-content');

  let expr='',memory=Number(localStorage.getItem('exam_calc_memory')||0),history=JSON.parse(localStorage.getItem('exam_calc_history')||'[]'),angleMode=localStorage.getItem('exam_calc_angle')||'deg',precision=Number(localStorage.getItem('exam_calc_precision')||6),notebookMode=localStorage.getItem('exam_calc_notebook')==='1',soundThemeVal=localStorage.getItem('exam_calc_sound')||'none';

  // Update status bar
  function updateStatusBar() {
    memoryStatus.textContent = `Memory: ${fmtNum(memory)}`;
    angleStatus.textContent = `Angle: ${angleMode.toUpperCase()}`;
    precisionStatus.textContent = `Precision: ${precision}`;
  }

  // Tab functionality
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tabContents.forEach(c => c.classList.remove('active'));
      
      tab.classList.add('active');
      $(`#${tab.dataset.tab}-tab`).classList.add('active');
    });
  });

  const catalog=[{name:'sin',sig:'sin(x)',desc:'Sine ‚Äî respects DEG/RAD',examples:['sin(30)']},{name:'cos',sig:'cos(x)',desc:'Cosine',examples:['cos(60)']},{name:'tan',sig:'tan(x)',desc:'Tangent',examples:['tan(45)']},{name:'sqrt',sig:'sqrt(x)',desc:'Square root',examples:['sqrt(9)']},{name:'pow',sig:'pow(a,b)',desc:'Power',examples:['pow(2,3)']},{name:'fact',sig:'fact(n)',desc:'Factorial',examples:['5!']},{name:'nCr',sig:'nCr(n,r)',desc:'Combinations',examples:['nCr(10,3)']},{name:'nPr',sig:'nPr(n,r)',desc:'Permutations',examples:['nPr(5,2)']},{name:'gcd',sig:'gcd(a,b)',desc:'Greatest common divisor'},{name:'lcm',sig:'lcm(a,b)',desc:'Least common multiple'},{name:'isprime',sig:'isprime(n)',desc:'Prime test'},{name:'pfactor',sig:'pfactor(n)',desc:'Prime factorization'},{name:'ln',sig:'ln(x)',desc:'Natural log'},{name:'log',sig:'log(x)',desc:'Log base 10'},{name:'PI',sig:'PI',desc:'œÄ constant'},{name:'E',sig:'E',desc:'e constant'},{name:'rand',sig:'rand()',desc:'Random 0..1'},{name:'floor',sig:'floor(x)',desc:'Round down'},{name:'ceil',sig:'ceil(x)',desc:'Round up'}];

  const units={
    length:{m:1,km:1000,cm:0.01,mm:0.001,in:0.0254,ft:0.3048,yd:0.9144,mi:1609.344},
    mass:{g:1,kg:1000,mg:0.001,lb:453.59237,oz:28.349523125},
    temp:{c:'C',f:'F',k:'K'},
    pressure:{pa:1,kpa:1000,bar:100000,atm:101325,psi:6894.75729,torr:133.322368},
    energy:{j:1,kj:1000,cal:4.184,kcal:4184,ev:1.602176634e-19},
    time:{s:1,ms:0.001,min:60,h:3600,day:86400},
    digital:{b:1,kb:1024,mb:1048576,gb:1073741824},
    voltage:{v:1,mv:0.001,kv:1000}
  };

  const FORBIDDEN=/\b(window|document|localStorage|sessionStorage|indexedDB|fetch|XMLHttpRequest|import|require|process|eval|Function)\b/i;
  function sanitizeExpression(s){ if(FORBIDDEN.test(s))throw new Error('Forbidden token in expression'); return s }

  function factorial(n){const k=Math.floor(n);if(k<0||k!==n||k>170)throw new Error('Invalid factorial');let r=1;for(let i=2;i<=k;i++)r*=i;return r}
  function gcd(a,b){a=Math.abs(Math.floor(a));b=Math.abs(Math.floor(b));if(!a)return b;if(!b)return a;while(b){const t=b;b=a%b;a=t}return a}
  function lcm(a,b){if(a===0||b===0)return 0;return Math.abs(Math.floor(a)/gcd(a,b)*Math.floor(b))}
  function isPrimeSimple(n){n=Math.floor(n);if(n<=1)return false;if(n<=3)return true;if(n%2===0)return false;const r=Math.floor(Math.sqrt(n));for(let i=3;i<=r;i+=2)if(n%i===0)return false;return true}
  function primeFactors(n){n=Math.abs(Math.floor(n));const out=[];let d=2;while(d*d<=n){while(n%d===0){out.push(d);n/=d}d=(d===2)?3:d+2}if(n>1)out.push(n);return out}

  function buildSandbox(){
    return{
      sin:x=>angleMode==='deg'?Math.sin(x*Math.PI/180):Math.sin(x),
      cos:x=>angleMode==='deg'?Math.cos(x*Math.PI/180):Math.cos(x),
      tan:x=>angleMode==='deg'?Math.tan(x*Math.PI/180):Math.tan(x),
      asin:x=>angleMode==='deg'?Math.asin(x)*180/Math.PI:Math.asin(x),
      acos:x=>angleMode==='deg'?Math.acos(x)*180/Math.PI:Math.acos(x),
      atan:x=>angleMode==='deg'?Math.atan(x)*180/Math.PI:Math.atan(x),
      sqrt:x=>Math.sqrt(x),pow:(a,b)=>Math.pow(a,b),abs:x=>Math.abs(x),exp:x=>Math.exp(x),
      ln:x=>Math.log(x),log:x=>(Math.log10?Math.log10(x):Math.log(x)/Math.LN10),rand:()=>Math.random(),
      PI:Math.PI,E:Math.E,fact:factorial,
      nCr:(n,r)=>{n=Math.floor(n);r=Math.floor(r);if(r<0||n<0||r>n)return 0;if(r>n-r)r=n-r;let num=1,den=1;for(let i=1;i<=r;i++){num*=(n-r+i);den*=i}return Math.round(num/den)},
      nPr:(n,r)=>{n=Math.floor(n);r=Math.floor(r);if(r<0||n<0||r>n)return 0;let res=1;for(let i=0;i<r;i++)res*=(n-i);return res},
      gcd:(a,b)=>gcd(a,b),lcm:(a,b)=>lcm(a,b),isprime:(n)=>isPrimeSimple(n),pfactor:(n)=>primeFactors(n),
      floor:x=>Math.floor(x),ceil:x=>Math.ceil(x),round:x=>Math.round(x)
    }
  }

  function preprocess(expression){
    let s=String(expression).replace(/\s+/g,'');
    const reFact=/(\d+(?:\.\d+)?|\([^()]*\))!/;
    while(reFact.test(s))s=s.replace(reFact,'fact($1)');
    s=s.replace(/(\d+(?:\.\d+)?)%/g,'($1/100)');
    s=s.replace(/([A-Za-z_]\w*|\d+(?:\.\d+)?|\([^()]*\))\^([A-Za-z_]\w*|\d+(?:\.\d+)?|\([^()]*\))/g,'pow($1,$2)');
    return s
  }

  function evaluateExpression(input){
    if(!input||String(input).trim()==='')return '';
    try{
      sanitizeExpression(input);
      const processed=preprocess(input);
      const sb=buildSandbox();
      const keys=Object.keys(sb),args=keys.map(k=>sb[k]);
      const fn=new Function(...keys,'return ('+processed+');');
      return fn(...args)
    }catch(err){return 'Error'}
  }

  function isTempUnit(u){return['c','f','k','¬∞c','¬∞f'].includes(u.toLowerCase())}
  function findUnitFamily(unit){unit=String(unit).trim().toLowerCase();for(const family of Object.keys(units)){if(units[family][unit]!==undefined)return family}const norm=unit.replace('¬∞','');for(const family of Object.keys(units)){if(units[family][norm]!==undefined)return family}return null}

  function convertUnits(value,from,to){
    from=String(from).trim().toLowerCase();to=String(to).trim().toLowerCase();
    if(isTempUnit(from)||isTempUnit(to)){
      const f=from[0].toLowerCase(),t=to[0].toLowerCase();let c;
      if(f==='c')c=value;else if(f==='f')c=(value-32)*5/9;else if(f==='k')c=value-273.15;else throw'Unsupported temp unit';
      if(t==='c')return c; if(t==='f')return c*9/5+32; if(t==='k')return c+273.15
    }
    for(const key of Object.keys(units)){
      if(units[key][from]!==undefined&&units[key][to]!==undefined) return value*units[key][from]/units[key][to]
    }
    throw'Incompatible or unknown units'
  }

  function tryParseConversion(input){
    if(!input) return null;
    const m=input.match(/^(-?\d+(?:\.\d+)?)\s*([A-Za-z¬∞]+)\s+to\s+([A-Za-z¬∞]+)$/i);
    if(m) return {value:parseFloat(m[1]),from:m[2],to:m[3]};
    const m2=input.match(/^(-?\d+(?:\.\d+)?)([A-Za-z¬∞]+)\s+to\s+([A-Za-z¬∞]+)$/i);
    if(m2) return {value:parseFloat(m2[1]),from:m2[2],to:m2[3]};
    const m3=input.match(/^(-?\d+(?:\.\d+)?)\s*([A-Za-z¬∞]+)\s+to\s*$/i);
    if(m3) return {value:parseFloat(m3[1]),from:m3[2],to:null};
    return null
  }

  function validateExpression(expr){
    const warnings=[];
    try{
      const factCalls=expr.matchAll(/fact\(([^()]+)\)|(\d+)!/g);
      for(const f of factCalls){const arg=f[1]||f[2];if(arg){const val=Number(arg);if(!Number.isFinite(val)||val<0||Math.floor(val)!==val)warnings.push('factorial requires a non-negative integer');if(val>170)warnings.push('factorial may overflow (n > 170)')}}
      const sqrtCalls=expr.matchAll(/sqrt\(([^()]+)\)/g);for(const s of sqrtCalls){const val=Number(s[1]);if(Number.isFinite(val)&&val<0)warnings.push('sqrt requires non-negative argument')}
      const logCalls=expr.matchAll(/(?:ln|log|log10)\(([^()]+)\)/g);for(const l of logCalls){const val=Number(l[1]);if(Number.isFinite(val)&&val<=0)warnings.push('log/ln require positive argument')}
      const asinCalls=expr.matchAll(/(?:asin|acos)\(([^()]+)\)/g);for(const a of asinCalls){const val=Number(a[1]);if(Number.isFinite(val)&&(val<-1||val>1))warnings.push('asin/acos require values between -1 and 1')}
      if(/[\/]\s*0(?!\d)/.test(expr))warnings.push('possible division by zero');
    }catch(e){}
    return [...new Set(warnings)]
  }

  function fmtNum(v){if(typeof v==='number'&&isFinite(v)){if(precision===0)return String(Math.round(v));return Number.parseFloat(v).toFixed(precision).replace(/\.?0+$/,'')}return String(v)}

  function pushHistory(e,r){history.push({expr:e,result:r,ts:Date.now()});if(history.length>1000)history.shift();localStorage.setItem('exam_calc_history',JSON.stringify(history));renderHistoryList()}

  function renderHistoryList(){historyList.innerHTML='';if(!history.length){historyList.innerHTML='<div style="padding:10px;color:#456">No history yet.</div>';return}for(let i=history.length-1;i>=0;i--){const item=history[i],el=document.createElement('div');el.className='history-item';el.innerHTML=`<div style="flex:1"><strong>${escapeHtml(item.expr)}</strong><small>= ${escapeHtml(fmtNum(item.result))}</small></div><div style="display:flex;gap:6px"><button data-load="${i}" aria-label="load">Load</button><button data-copy="${i}" aria-label="copy">Copy</button></div>`;historyList.appendChild(el)}try{if(window.MathJax&&MathJax.typesetPromise)MathJax.typesetPromise([historyList]).catch(()=>{})}catch(e){}
  }

  function escapeHtml(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

  let suggestions=[],suggestionIndex=-1;
  function getAlphaToken(){const m=expr.match(/[A-Za-z_]\w*$/);return m?m[0]:''}

  function updateAutocomplete(){
    const convPartial=expr.match(/^(-?\d+(?:\.\d+)?)\s*([A-Za-z¬∞]+)\s+to\s*([A-Za-z¬∞]*)$/i);
    if(convPartial){const value=parseFloat(convPartial[1]),from=convPartial[2],partialTarget=convPartial[3]||'';const family=findUnitFamily(from);if(!family){renderConversionSuggestions([]);return}const unitsList=Object.keys(units[family]).filter(u=>u.toLowerCase()!==from.toLowerCase());const filtered=partialTarget?unitsList.filter(u=>u.toLowerCase().startsWith(partialTarget.toLowerCase())):unitsList;const out=filtered.map(u=>{try{const convVal=convertUnits(value,from,u);return{unit:u,preview:fmtNum(convVal)}}catch(e){return{unit:u,preview:'err'}}});renderConversionSuggestions(out,value,from);return}
    const token=getAlphaToken();if(!token){hideAutocomplete();hideArgHint();return}const low=token.toLowerCase();suggestions=catalog.filter(c=>c.name.toLowerCase().includes(low)).slice(0,12);suggestionIndex=suggestions.length?0:-1;renderFunctionAutocomplete()
  }

  function renderConversionSuggestions(list,value=0,from=''){autocomplete.innerHTML='';if(!list.length){autocomplete.style.display='none';return}list.forEach((s,i)=>{const d=document.createElement('div');d.className='suggest';d.dataset.index=i;d.innerHTML=`<div><strong>${s.unit}</strong><div style="font-size:0.85rem;color:#9fd3ff">convert ${value} ${from} ‚Üí ${s.preview} ${s.unit}</div></div><div class="unit-preview">${s.preview}</div>`;d.addEventListener('click',()=>acceptConversionSuggestion(value,from,s.unit));d.addEventListener('mousemove',ev=>showTooltip(`Convert ${value} ${from} ‚Üí ${s.preview} ${s.unit}`,ev.clientX+10,ev.clientY+10));d.addEventListener('mouseleave',hideTooltip);autocomplete.appendChild(d)});autocomplete.style.display='block';autocomplete.setAttribute('aria-hidden','false');suggestions=list;suggestionIndex=0;highlightSuggestion()}

  function acceptConversionSuggestion(value,from,to){expr=`${value} ${from} to ${to}`;renderMain();try{const res=convertUnits(value,from,to);pushHistory(expr,res);expr=String(res);renderMain();preview.textContent='= '+fmtNum(res)}catch(e){preview.textContent='Conversion error'}hideAutocomplete();hideArgHint()}

  function renderFunctionAutocomplete(){autocomplete.innerHTML='';if(!suggestions.length){autocomplete.style.display='none';return}suggestions.forEach((s,i)=>{const d=document.createElement('div');d.className='suggest';d.dataset.index=i;d.innerHTML=`<div><strong>${s.name}</strong><div style="font-size:0.85rem;color:#9fd3ff">${s.desc}</div></div><div style="opacity:.9">${s.sig||''}</div>`;d.addEventListener('click',()=>acceptFunctionSuggestion(i));d.addEventListener('mousemove',ev=>showTooltip((s.sig||s.name)+' ‚Äî '+s.desc,ev.clientX+10,ev.clientY+10));d.addEventListener('mouseleave',hideTooltip);autocomplete.appendChild(d)});autocomplete.style.display='block';autocomplete.setAttribute('aria-hidden','false');suggestionIndex=Math.max(0,suggestionIndex);highlightSuggestion()}

  function highlightSuggestion(){const children=Array.from(autocomplete.children);children.forEach((c,idx)=>{c.style.background=(idx===suggestionIndex)?'rgba(255,255,255,.05)':'transparent';if(idx===suggestionIndex) c.scrollIntoView({block:'nearest'})})}

  function acceptFunctionSuggestion(i){if(i<0||i>=suggestions.length)return;const s=suggestions[i];const token=getAlphaToken();if(token)expr=expr.slice(0,-token.length);expr+=(s.sig&&s.name!=='PI'&&s.name!=='E')?s.name+'(':s.name;renderMain();hideAutocomplete();updateArgHint()}
  function hideAutocomplete(){autocomplete.style.display='none';suggestions=[];suggestionIndex=-1;autocomplete.setAttribute('aria-hidden','true')}
  function showTooltip(text,x,y){tooltip.textContent=text;tooltip.style.left=(x+8)+'px';tooltip.style.top=(y+8)+'px';tooltip.style.display='block'}
  function hideTooltip(){tooltip.style.display='none'}

  function checkAndShowValidation(currentExpr){const warnings=validateExpression(currentExpr);if(warnings.length){document.getElementById('validationMessage').classList.add('warning');document.getElementById('validationMessage').innerHTML='<strong>Fix before evaluating:</strong><div style="margin-top:6px">'+warnings.join('<br>')+'</div>';document.getElementById('validationMessage').style.display='block';return false}else{document.getElementById('validationMessage').style.display='none';return true}}

  function evaluateAndShow(){
    const conv=tryParseConversion(expr);
    if(conv&&conv.to){try{const val=convertUnits(conv.value,conv.from,conv.to);const out=fmtNum(val);pushHistory(expr,val);expr=String(val);renderMain();preview.textContent='= '+out;return}catch(err){preview.textContent='Conversion error: '+err;return}}
    if(!checkAndShowValidation(expr))return;
    const result=evaluateExpression(expr);
    if(result==='Error'){preview.textContent='Error';}
    else{preview.textContent='= '+fmtNum(result);pushHistory(expr,result);expr=String(result);renderMain()}
    hideAutocomplete();hideArgHint();
    updateStatusBar();
  }

  function renderMain(){display.value=expr||'0';}

  document.addEventListener('keydown',e=>{
    if(autocomplete.style.display==='block'&&suggestions.length){if(e.key==='ArrowDown'){e.preventDefault();suggestionIndex=(suggestionIndex+1)%suggestions.length;highlightSuggestion();return}if(e.key==='ArrowUp'){e.preventDefault();suggestionIndex=(suggestionIndex-1+suggestions.length)%suggestions.length;highlightSuggestion();return}if(e.key==='Enter'&&suggestionIndex>=0){const first=suggestions[0];if(first&&first.unit!==undefined){const sel=suggestions[suggestionIndex];const convPartial=expr.match(/^(-?\d+(?:\.\d+)?)\s*([A-Za-z¬∞]+)\s+to\s*([A-Za-z¬∞]*)$/i);if(convPartial){acceptConversionSuggestion(parseFloat(convPartial[1]),convPartial[2],sel.unit);e.preventDefault();return}}else{acceptFunctionSuggestion(suggestionIndex);e.preventDefault();return}}if(e.key==='Escape'){hideAutocomplete();hideArgHint();return}}
    if(document.activeElement===display){return}
    if(e.key>='0'&&e.key<='9'){expr+=e.key;renderMain();updateAutocomplete();return}
    if(e.key==='.'){expr+='.';renderMain();updateAutocomplete();return}
    if('+-*/%^()'.includes(e.key)){expr+=e.key;renderMain();updateAutocomplete();return}
    if(e.key==='Enter'){evaluateAndShow();return}
    if(e.key==='Backspace'){expr=expr.slice(0,-1);renderMain();updateAutocomplete();return}
    if(e.key==='Escape'){expr='';renderMain();preview.textContent='';hideAutocomplete();hideArgHint();return}
    if(/^[a-zA-Z]$/.test(e.key)){expr+=e.key;renderMain();updateAutocomplete();return}
    if(e.key==='!'){expr+='!';renderMain();updateAutocomplete();return}
    // Keyboard shortcuts
    if(e.ctrlKey){
      if(e.key==='m'||e.key==='M'){e.preventDefault();memory=0;localStorage.setItem('exam_calc_memory',String(memory));updateStatusBar();}
      if(e.key==='d'||e.key==='D'){e.preventDefault();document.documentElement.classList.toggle('dark');const pressed=darkToggle.getAttribute('aria-pressed')==='true';darkToggle.setAttribute('aria-pressed',!pressed);}
    }
  });

  display.addEventListener('input',()=>{expr=display.value;updateAutocomplete();});
  display.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault();evaluateAndShow();}});

  document.getElementById('keys').addEventListener('click',e=>{const btn=e.target.closest('.key');if(!btn)return;const val=btn.getAttribute('data-val'),fn=btn.getAttribute('data-fn'),action=btn.getAttribute('data-action');
    if(val){expr+=val;renderMain();updateAutocomplete();}
    else if(fn){if(!expr){if(fn==='pi')expr+='PI';else if(fn==='rand')expr+='rand()';else expr+=fn+'('}else{if(['fact','rand','pi','isprime','pfactor'].includes(fn)){if(fn==='fact')expr='fact('+expr+')';else if(fn==='rand')expr+='rand()';else if(fn==='pi')expr+='PI';else if(fn==='isprime')expr+='isprime('+expr+')';else if(fn==='pfactor')expr='pfactor('+expr+')'}else if(fn==='pow')expr+='^';else expr=fn+'('+expr+')'}renderMain();updateAutocomplete();updateArgHint();}
    else if(action){if(action==='clear'){expr='';renderMain();preview.textContent='Type an expression';hideAutocomplete();hideArgHint()}else if(action==='back'){expr=expr.slice(0,-1);renderMain();updateAutocomplete()}else if(action==='equals'){evaluateAndShow();hideAutocomplete();hideArgHint()}else if(action==='mc'){memory=0;localStorage.setItem('exam_calc_memory',String(memory));updateStatusBar();}else if(action==='mr'){expr+=String(memory);renderMain();updateAutocomplete()}else if(action==='mplus'){const v=evaluateExpression(expr);if(typeof v==='number'&&isFinite(v))memory+=v;localStorage.setItem('exam_calc_memory',String(memory));updateStatusBar();}else if(action==='mminus'){const v=evaluateExpression(expr);if(typeof v==='number'&&isFinite(v))memory-=v;localStorage.setItem('exam_calc_memory',String(memory));updateStatusBar();}});

  historyList.addEventListener('click',e=>{const load=e.target.getAttribute('data-load'),copy=e.target.getAttribute('data-copy');if(load!==null){const it=history[load];if(it){expr=it.expr;renderMain();}}if(copy!==null){const it=history[copy];if(it)navigator.clipboard?.writeText(String(it.result)).catch(()=>{})}});

  convertBtn.addEventListener('click',()=>{const v=unitInput.value.trim();if(!v)return;const parsed=tryParseConversion(v);if(!parsed){preview.textContent='Try: 10 km to m or 100kPa to bar';return}try{const res=convertUnits(parsed.value,parsed.from,parsed.to);preview.textContent='= '+fmtNum(res);pushHistory(v,res)}catch(e){preview.textContent='Conversion error: '+e}});

  exportTxt.addEventListener('click',()=>{let text='Exam-Calc History\n-----------------\n';history.forEach(h=>text+=h.expr+' = '+fmtNum(h.result)+'\n');const blob=new Blob([text],{type:'text/plain;charset=utf-8'}),a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='exam-calc-history.txt';a.click();URL.revokeObjectURL(a.href)});
  exportPng.addEventListener('click',async()=>{try{const node=document.querySelector('.calc');const canvas=await html2canvas(node,{scale:2,backgroundColor:null});const a=document.createElement('a');a.href=canvas.toDataURL('image/png');a.download='exam-calc.png';a.click()}catch(e){alert('PNG export failed')}});
  exportPdf.addEventListener('click',async()=>{try{const node=document.querySelector('.calc');const canvas=await html2canvas(node,{scale:2,backgroundColor:null});const imgData=canvas.toDataURL('image/png');const{jsPDF}=window.jspdf;const pdf=new jsPDF({orientation:'landscape',unit:'pt',format:[canvas.width,canvas.height]});pdf.addImage(imgData,'PNG',0,0,canvas.width,canvas.height);pdf.save('exam-calc.pdf')}catch(e){alert('PDF export failed')}});

  openOnboarding.addEventListener('click',()=>{onboardingModal.style.display='flex'});closeOnboarding.addEventListener('click',()=>{onboardingModal.style.display='none'});
  showShortcuts.addEventListener('click',()=>{shortcutsModal.style.display='flex'});closeShortcuts.addEventListener('click',()=>{shortcutsModal.style.display='none'});
  angleToggle.addEventListener('click',()=>{angleMode=angleMode==='deg'?'rad':'deg';angleLabel.textContent=angleMode.toUpperCase();angleStatus.textContent=`Angle: ${angleMode.toUpperCase()}`;localStorage.setItem('exam_calc_angle',angleMode);});
  precisionSelect.addEventListener('change',()=>{precision=Number(precisionSelect.value||6);precisionStatus.textContent=`Precision: ${precision}`;localStorage.setItem('exam_calc_precision',String(precision));});
  notebookToggle.addEventListener('click',()=>{notebookMode=!notebookMode;localStorage.setItem('exam_calc_notebook',notebookMode?'1':'0');document.body.classList.toggle('notebook-mode',notebookMode)});
  soundTheme.value=soundThemeVal||'none';soundTheme.addEventListener('change',()=>{soundThemeVal=soundTheme.value;localStorage.setItem('exam_calc_sound',soundThemeVal)});
  testSound.addEventListener('click',()=>{if(soundThemeVal&&soundThemeVal!=='none') playTheme(soundThemeVal)});

  clearHistoryBtn.addEventListener('click',()=>{if(confirm('Clear history?')){history=[];localStorage.removeItem('exam_calc_history');renderHistoryList()}});
  copyHistoryBtn.addEventListener('click',()=>{const out=history.map(h=>h.expr+' = '+fmtNum(h.result)).join('\n');navigator.clipboard?.writeText(out).then(()=>alert('History copied'))});

  darkToggle.addEventListener('click',()=>{document.documentElement.classList.toggle('dark');const pressed=darkToggle.getAttribute('aria-pressed')==='true';darkToggle.setAttribute('aria-pressed',!pressed)});

  function init(){display.value='0';angleLabel.textContent=angleMode.toUpperCase();precisionSelect.value=String(precision);if(notebookMode)document.body.classList.add('notebook-mode');renderHistoryList();updateStatusBar();}
  init();

  $$('.key').forEach(btn=>{btn.addEventListener('click',function(e){const r=document.createElement('span'),d=Math.max(this.offsetWidth,this.offsetHeight);r.style.width=r.style.height=d+'px';r.style.left=(e.offsetX-d/2)+'px';r.style.top=(e.offsetY-d/2)+'px';r.className='ripple';this.appendChild(r);setTimeout(()=>r.remove(),550)})});

  window.examCalc={evaluate:evaluateExpression,convertUnits,validateExpression:getWarnings=>validateExpression(getWarnings),getState:()=>({expr,history,angleMode,precision})};

})();
</script>
</body>
</html>
