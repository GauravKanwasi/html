<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gemini Pro Scientific Calculator v3</title>
    <style>
        :root {
            --bg-grad-start: #6a82fb; --bg-grad-end: #fc5c7d;
            --calc-bg: rgba(255, 255, 255, 0.95); --display-bg: #f8f9fa;
            --text-primary: #2d3748; --text-secondary: #6c757d; --btn-bg: #f7fafc;
            --btn-shadow: 0 4px 10px rgba(0,0,0,0.06); --btn-hover-shadow: 0 7px 18px rgba(0,0,0,0.1);
            --operator-bg: #4299e1; --equals-bg: #48bb78; --clear-bg: #f56565;
            --function-bg: #ed8936; --memory-bg: #38b2ac; --btn-text-light: white;
            --second-fn-active-bg: #c05621; --modal-overlay-bg: rgba(0, 0, 0, 0.5);
        }
        [data-theme="dark"] {
            --bg-grad-start: #232526; --bg-grad-end: #414345;
            --calc-bg: rgba(45, 55, 72, 0.95); --display-bg: #2d3748;
            --text-primary: #edf2f7; --text-secondary: #a0aec0; --btn-bg: #4a5568;
            --operator-bg: #2b6cb0; --equals-bg: #2f855a; --clear-bg: #c53030;
            --function-bg: #dd6b20; --memory-bg: #2c7a7b; --second-fn-active-bg: #9c4221;
            --modal-overlay-bg: rgba(0, 0, 0, 0.7);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body {
            background: linear-gradient(135deg, var(--bg-grad-start) 0%, var(--bg-grad-end) 100%);
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            padding: 20px; transition: background 0.3s ease;
            -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
            -webkit-tap-highlight-color: transparent;
        }
        .calculator {
            background: var(--calc-bg); border-radius: 20px; padding: 25px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); width: 100%;
            max-width: 480px; transition: background 0.3s ease;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px; }
        .header h1 { font-size: 1.2rem; color: var(--text-primary); font-weight: 600; }
        .display {
            background: var(--display-bg); border-radius: 12px; padding: 15px 20px;
            margin-bottom: 20px; text-align: right; position: relative;
        }
        .display-header { display: flex; justify-content: space-between; align-items: center; height: 20px; margin-bottom: 5px; font-size: 0.8rem; font-weight: bold; color: var(--text-secondary); }
        #memoryIndicator { visibility: hidden; }
        #expression { min-height: 24px; font-size: 1rem; color: var(--text-secondary); word-wrap: break-word; word-break: break-all; }
        #result { font-size: 2.8rem; font-weight: bold; color: var(--text-primary); min-height: 60px; word-wrap: break-word; word-break: break-all; line-height: 1.2; }
        .buttons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; }
        .btn {
            border: none; padding: 16px 10px; border-radius: 12px; font-size: 1.1rem;
            font-weight: 600; cursor: pointer; background: var(--btn-bg); color: var(--text-primary);
            box-shadow: var(--btn-shadow); user-select: none;
            transition: transform 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
            will-change: transform, box-shadow;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: var(--btn-hover-shadow); }
        .btn:active, .btn.active-key { transform: translateY(-1px); filter: brightness(0.9); transition-duration: 0.05s; }
        .btn[data-action="operator"] { background: var(--operator-bg); color: var(--btn-text-light); }
        .btn[data-action="equals"] { background: var(--equals-bg); color: var(--btn-text-light); }
        .btn[data-action="clear"], .btn[data-action="backspace"] { background: var(--clear-bg); color: var(--btn-text-light); }
        .btn[data-action="function"] { background: var(--function-bg); color: var(--btn-text-light); }
        .btn[data-action="memory"] { background: var(--memory-bg); color: var(--btn-text-light); }
        .btn.second-fn.active { background: var(--second-fn-active-bg); }

        .history {
            margin-top: 20px; max-height: 120px; overflow-y: auto; background: var(--display-bg);
            border-radius: 10px; padding: 10px; scrollbar-width: thin;
        }
        .history-item { padding: 8px; border-bottom: 1px solid rgba(128,128,128,0.1); cursor: pointer; font-size: 0.9rem; color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; }
        .history-item:last-child { border-bottom: none; }
        .copy-icon { cursor: copy; margin-left: 10px; opacity: 0.7; }
        .copy-icon:hover { opacity: 1; }

        /* --- Modal Styles --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-overlay-bg); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--calc-bg); padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 90%; max-width: 400px; position: relative; transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-title { color: var(--text-primary); margin-bottom: 20px; text-align: center; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary); }
        .converter-row { display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-bottom: 15px; }
        .converter-row select, .converter-row input { width: 100%; padding: 10px; border: 1px solid var(--text-secondary); background: var(--display-bg); color: var(--text-primary); border-radius: 8px; font-size: 1rem; }
        .converter-result { margin-top: 20px; text-align: center; }
        .converter-result-value { font-size: 1.8rem; font-weight: bold; color: var(--text-primary); word-break: break-all; }
        .copy-result-btn { background: var(--operator-bg); color: var(--btn-text-light); border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body data-theme="dark">

    <div class="calculator">
        <div class="header">
            <h1>Gemini Pro v3</h1>
        </div>
        <div class="display">
            <div class="display-header"><span id="memoryIndicator">M</span></div>
            <div id="expression">&nbsp;</div>
            <div id="result">0</div>
        </div>
        <div class="buttons">
            <button class="btn second-fn" id="secondFnBtn">2nd</button>
            <button class="btn" id="unitConverterBtn" title="Unit Converter">Unit</button>
            <button class="btn" id="modeToggle">DEG</button>
            <button class="btn" data-action="clear">C</button>
            <button class="btn" data-action="backspace">⌫</button>

            <button class="btn" data-value="mc" data-action="memory">MC</button>
            <button class="btn" data-value="mr" data-action="memory">MR</button>
            <button class="btn" data-value="m+" data-action="memory">M+</button>
            <button class="btn" data-value="m-" data-action="memory">M-</button>
            <button class="btn" data-key="/" data-display="÷" data-action="operator">÷</button>

            <button class="btn fn-toggle" data-key="**2" data-key-alt="**3" data-display="x²" data-display-alt="x³">x²</button>
            <button class="btn" data-value="7">7</button>
            <button class="btn" data-value="8">8</button>
            <button class="btn" data-value="9">9</button>
            <button class="btn" data-key="*" data-display="×" data-action="operator">×</button>

            <button class="btn" data-key="Math.sqrt(" data-display="√">√</button>
            <button class="btn" data-value="4">4</button>
            <button class="btn" data-value="5">5</button>
            <button class="btn" data-value="6">6</button>
            <button class="btn" data-key="-" data-action="operator">-</button>

            <button class="btn" data-key="**" data-display="^" data-action="operator">xʸ</button>
            <button class="btn" data-value="1">1</button>
            <button class="btn" data-value="2">2</button>
            <button class="btn" data-value="3">3</button>
            <button class="btn" data-key="+" data-action="operator">+</button>

            <button class="btn" data-key="Math.PI" data-display="π">π</button>
            <button class="btn" data-key="ans" data-display="Ans">Ans</button>
            <button class="btn" data-value="0">0</button>
            <button class="btn" data-key=".">.</button>
            <button class="btn" data-action="equals">=</button>
        </div>
        <div class="history" id="historyContainer"></div>
    </div>

    <div class="modal-overlay" id="unitConverterModal">
        <div class="modal-content">
            <button class="modal-close" id="modalCloseBtn">&times;</button>
            <h2 class="modal-title">Unit Converter</h2>
            <select id="conversionType">
                <option value="length">Length</option>
                <option value="mass">Mass</option>
                <option value="temperature">Temperature</option>
            </select>
            <div class="converter-row">
                <input type="number" id="fromValue" value="1">
                <select id="fromUnit"></select>
                <span>=</span>
                <select id="toUnit"></select>
            </div>
            <div class="converter-result">
                <div class="converter-result-value" id="converterResult">...</div>
                <button class="copy-result-btn" id="copyResultBtn">Copy Result</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE & CONSTANTS ---
    let currentInput = '';
    let expressionForDisplay = '';
    let lastResult = '';
    let memoryValue = parseFloat(localStorage.getItem('calcMemory')) || 0;
    let isRadianMode = false;
    let calculationHistory = JSON.parse(localStorage.getItem('calcHistory_v3')) || [];
    const OPERATORS = ['+', '-', '*', '/', '**'];

    // --- DOM ELEMENTS ---
    const displayResult = document.getElementById('result');
    const displayExpression = document.getElementById('expression');
    const memoryIndicator = document.getElementById('memoryIndicator');
    const buttons = document.querySelector('.buttons');
    const historyContainer = document.getElementById('historyContainer');
    // ... more elements fetched as needed inside functions

    // --- HELPER FUNCTIONS ---
    const factorial = n => (n < 0 || n % 1 !== 0) ? NaN : (n <= 1 ? 1 : n * factorial(n - 1));

    const formatResult = (num) => {
        const numAbs = Math.abs(num);
        if (numAbs > 1e12 || (numAbs < 1e-6 && numAbs !== 0)) {
            return num.toExponential(6);
        }
        return String(parseFloat(num.toPrecision(12)));
    };

    // --- UI UPDATE FUNCTIONS ---
    const updateDisplay = () => {
        const len = currentInput.length;
        if (len > 18) displayResult.style.fontSize = '1.5rem';
        else if (len > 12) displayResult.style.fontSize = '2rem';
        else displayResult.style.fontSize = '2.8rem';
        
        displayResult.textContent = currentInput || '0';
        displayExpression.textContent = expressionForDisplay || '\u00A0';
        memoryIndicator.style.visibility = memoryValue !== 0 ? 'visible' : 'hidden';
    };

    const updateHistory = () => {
        historyContainer.innerHTML = calculationHistory.slice(-10).reverse().map(item =>
            `<div class="history-item" data-expression="${item.expression}" data-result="${item.result}">
                <span>${item.display} = ${item.result}</span>
                <span class="copy-icon" title="Copy Expression">📋</span>
            </div>`
        ).join('');
    };

    // --- CORE LOGIC ---
    const handleCalculation = () => {
        if (!currentInput) return;
        try {
            if (/\/0(?!\.)/.test(currentInput)) throw new Error("Division by Zero");

            let expressionToEval = currentInput.replace(/ans/g, `(${lastResult || 0})`).replace(/π/g, 'Math.PI');
            expressionToEval = expressionToEval.replace(/(\d*\.?\d+)!/g, (match, num) => `factorial(${num})`);

            const trigMultiplier = isRadianMode ? '1' : '(Math.PI/180)';
            expressionToEval = expressionToEval.replace(/(Math\.sin|Math\.cos|Math\.tan)\(/g, `$1(${trigMultiplier}*`);

            const answer = new Function('factorial', `"use strict"; return ${expressionToEval}`)(factorial);
            if (isNaN(answer) || !isFinite(answer)) throw new Error("Invalid Expression");

            const formattedAnswer = formatResult(answer);
            
            calculationHistory.push({ expression: currentInput, display: expressionForDisplay, result: formattedAnswer });
            if (calculationHistory.length > 20) calculationHistory.shift();
            localStorage.setItem('calcHistory_v3', JSON.stringify(calculationHistory));

            expressionForDisplay += ' =';
            lastResult = formattedAnswer;
            currentInput = formattedAnswer;
            updateHistory();

        } catch (error) {
            expressionForDisplay = error.message;
            currentInput = '';
        }
        updateDisplay();
    };
    
    const handleMemory = (value) => {
        const currentResultNum = parseFloat(displayResult.textContent);
        if (isNaN(currentResultNum) && value !== 'mc' && value !== 'mr') return;

        switch(value) {
            case 'mc': memoryValue = 0; break;
            case 'mr': currentInput += memoryValue.toString(); expressionForDisplay += memoryValue.toString(); break;
            case 'm+': memoryValue += currentResultNum; break;
            case 'm-': memoryValue -= currentResultNum; break;
        }
        localStorage.setItem('calcMemory', memoryValue);
        updateDisplay();
    };

    const processInput = (target) => {
        if (!target) return;
        if (navigator.vibrate) navigator.vibrate(10);
        
        let { key, value, display, action } = target.dataset;
        action = action || (value ? 'number' : (key ? 'special' : 'none'));
        display = display || value || key;

        if (expressionForDisplay.includes('=')) {
            expressionForDisplay = '';
            currentInput = OPERATORS.includes(key) ? lastResult : '';
        }
        
        switch(action) {
            case 'clear': currentInput = ''; expressionForDisplay = ''; lastResult = ''; break;
            case 'backspace':
                currentInput = currentInput.slice(0, -1);
                expressionForDisplay = expressionForDisplay.slice(0, -1);
                break;
            case 'equals': handleCalculation(); return;
            case 'memory': handleMemory(value); return;
            case 'number':
                currentInput += value; expressionForDisplay += display; break;
            case 'operator':
                 if (currentInput || key === '-') {
                    const lastIsOperator = OPERATORS.some(op => currentInput.endsWith(op));
                    if(lastIsOperator) {
                        currentInput = currentInput.slice(0, -currentInput.split('').reverse().find(c => OPERATORS.includes(c)).length) + key;
                        expressionForDisplay = expressionForDisplay.slice(0, -1) + display;
                    } else {
                        currentInput += key; expressionForDisplay += display;
                    }
                }
                break;
            default: // special, constants, functions
                const lastChar = expressionForDisplay.slice(-1);
                const isNumOrSpecial = !isNaN(parseInt(lastChar)) || [')', 'π', 's'].includes(lastChar);
                if(isNumOrSpecial && !target.innerHTML.startsWith('x')) {
                    currentInput += '*';
                    expressionForDisplay += '×';
                }
                currentInput += key === 'ans' ? 'ans' : key;
                expressionForDisplay += display;
                break;
        }
        updateDisplay();
    };

    // --- UNIT CONVERTER LOGIC ---
    const converter = {
        elements: {
            modal: document.getElementById('unitConverterModal'),
            type: document.getElementById('conversionType'),
            fromValue: document.getElementById('fromValue'),
            fromUnit: document.getElementById('fromUnit'),
            toUnit: document.getElementById('toUnit'),
            result: document.getElementById('converterResult'),
        },
        data: {
            length: { base: 'meter', units: { meter: 1, kilometer: 1000, centimeter: 0.01, mile: 1609.34, foot: 0.3048, inch: 0.0254 } },
            mass: { base: 'gram', units: { gram: 1, kilogram: 1000, milligram: 0.001, pound: 453.592, ounce: 28.3495 } },
            temperature: { base: 'celsius', units: { celsius: 'C', fahrenheit: 'F', kelvin: 'K' } }
        },
        init() {
            document.getElementById('unitConverterBtn').addEventListener('click', () => this.open());
            document.getElementById('modalCloseBtn').addEventListener('click', () => this.close());
            document.getElementById('copyResultBtn').addEventListener('click', () => this.copyResult());
            this.elements.modal.addEventListener('click', e => e.target === this.elements.modal && this.close());
            
            [this.elements.type, this.elements.fromValue, this.elements.fromUnit, this.elements.toUnit].forEach(el => {
                el.addEventListener('change', () => this.convert());
                if (el.type === 'number') el.addEventListener('keyup', () => this.convert());
            });
            this.populateUnits();
        },
        open() { this.elements.modal.classList.add('visible'); this.convert(); },
        close() { this.elements.modal.classList.remove('visible'); },
        populateUnits() {
            const type = this.elements.type.value;
            const units = Object.keys(this.data[type].units);
            this.elements.fromUnit.innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
            this.elements.toUnit.innerHTML = units.map(u => `<option value="${u}">${u}</option>`).join('');
            this.elements.toUnit.value = units[1] || units[0];
            this.convert();
        },
        convert() {
            const type = this.elements.type.value;
            const value = parseFloat(this.elements.fromValue.value);
            const from = this.elements.fromUnit.value;
            const to = this.elements.toUnit.value;
            if (isNaN(value)) { this.elements.result.textContent = '-'; return; }

            let result;
            if (type === 'temperature') {
                let tempInC;
                if (from === 'celsius') tempInC = value;
                else if (from === 'fahrenheit') tempInC = (value - 32) * 5/9;
                else tempInC = value - 273.15; // Kelvin

                if (to === 'celsius') result = tempInC;
                else if (to === 'fahrenheit') result = (tempInC * 9/5) + 32;
                else result = tempInC + 273.15; // Kelvin
            } else {
                const baseValue = value * this.data[type].units[from];
                result = baseValue / this.data[type].units[to];
            }
            this.elements.result.textContent = formatResult(result);
        },
        copyResult() {
            navigator.clipboard.writeText(this.elements.result.textContent);
            this.close();
        }
    };
    converter.init();
    
    // --- EVENT LISTENERS ---
    buttons.addEventListener('click', e => processInput(e.target.closest('.btn')));
    document.getElementById('modeToggle').addEventListener('click', (e) => {
        isRadianMode = !isRadianMode;
        e.target.textContent = isRadianMode ? 'RAD' : 'DEG';
    });
    historyContainer.addEventListener('click', (e) => {
        const item = e.target.closest('.history-item');
        if (!item) return;
        if (e.target.classList.contains('copy-icon')) {
            navigator.clipboard.writeText(item.dataset.expression);
            e.target.textContent = '✅';
            setTimeout(() => e.target.textContent = '📋', 1000);
        } else {
            currentInput = item.dataset.result;
            expressionForDisplay = item.dataset.expression;
            updateDisplay();
        }
    });

    // --- INITIALIZATION ---
    updateHistory();
    updateDisplay();
});
</script>
</body>
</html>
