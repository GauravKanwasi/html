<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Exam-Calc — Human Touch Edition</title>

<!-- Fonts: clean body + friendly handwritten heading -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Patrick+Hand&display=swap" rel="stylesheet">

<!-- Font Awesome for small icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

<style>
  /* ===== Theme & layout ===== */
  :root {
    --bg-1: #f3f6f9;
    --bg-2: #eef3f7;
    --panel: #223244;
    --panel-2: #2e4458;
    --accent: #f6b042;
    --muted: #90a4ae;
    --glass: rgba(255,255,255,0.6);
    --radius: 14px;
    --shadow-1: 0 10px 30px rgba(34,50,68,0.12);
    --shadow-2: 0 6px 16px rgba(34,50,68,0.08);
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));font-family:'Inter',system-ui,Arial,sans-serif;color:#0b2336}
  body{display:flex;align-items:center;justify-content:center;padding:28px;-webkit-font-smoothing:antialiased}
  /* container */
  .calc {
    width: 920px;
    max-width:96vw;
    border-radius:var(--radius);
    overflow:visible;
    background:linear-gradient(180deg,#ffffff,#f6fbff);
    box-shadow: var(--shadow-1);
    display:grid;
    grid-template-columns: 1fr 340px; /* main + side pane */
    gap: 18px;
    padding: 18px;
    align-items:start;
    position: relative;
  }

  /* Header: handwritten identity */
  .header {
    grid-column: 1 / -1;
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 12px;
    gap:12px;
  }
  .brand {
    display:flex;
    gap:12px;
    align-items:center;
  }
  .brand h1 {
    font-family: 'Patrick Hand', cursive;
    margin:0;
    font-size:1.5rem;
    letter-spacing:0.6px;
    color: #123447;
  }
  .brand small {
    display:block;
    font-size:0.75rem;
    color:var(--muted);
    margin-top:2px;
  }
  .header .controls { display:flex; gap:8px; align-items:center; }

  /* Main area + display */
  .main {
    background: linear-gradient(180deg, #ffffff, #f3f8fb);
    border-radius:12px;
    padding:14px;
    box-shadow: var(--shadow-2);
    min-height: 520px;
  }

  .display {
    background: linear-gradient(180deg,#fbfdff,#eef6ff);
    border-radius:12px;
    padding:14px;
    border:1px solid rgba(3,17,28,0.04);
    box-shadow: inset 0 2px 8px rgba(16,40,60,0.03);
  }
  #history {
    font-size:0.85rem;
    color:var(--muted);
    text-align:right;
    min-height:20px;
    margin-bottom:6px;
    padding-right:6px;
  }
  #preview {
    text-align:right;
    color:var(--accent);
    min-height:18px;
    font-size:0.95rem;
    margin-bottom:6px;
  }
  #display {
    width:100%;
    height:76px;
    border-radius:10px;
    border: none;
    padding:12px 14px;
    font-size:2.05rem;
    font-weight:700;
    text-align:right;
    background: #ffffff;
    color: #0a2230;
    box-shadow: inset 0 6px 18px rgba(16,40,60,0.04);
  }

  /* keys grid */
  .keys {
    margin-top:12px;
    display:grid;
    gap:10px;
  }
  .row {
    display:grid;
    grid-template-columns: repeat(8, 1fr);
    gap:10px;
  }

  .key {
    border-radius:10px;
    padding:10px 8px;
    cursor:pointer;
    border:none;
    font-weight:700;
    color:white;
    box-shadow: 0 8px 20px rgba(3,17,28,0.06);
    transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    position:relative;
    overflow:visible;
  }
  .key:active{ transform: translateY(1px) scale(.995); }

  /* tactile style groups */
  .num{ background: linear-gradient(180deg,#7d8a91,#6b7880); }
  .op { background: linear-gradient(180deg,#f39c12,#d35400); color: #fff; }
  .eq { background: linear-gradient(180deg,#27ae60,#188c43); color:#fff; }
  .clr { background: linear-gradient(180deg,#e74c3c,#c0392b); }
  .sci { background: linear-gradient(180deg,#3498db,#2e7bb9); }
  .mem { background: linear-gradient(180deg,#9b59b6,#8b3fb0); }

  /* micro-interaction: subtle ripple */
  .key::after{
    content:'';
    position:absolute;
    left:50%; top:50%;
    width:0; height:0; opacity:0;
    transform:translate(-50%,-50%);
    background:rgba(255,255,255,0.12);
    border-radius:50%;
    transition: width .35s ease, height .35s ease, opacity .35s ease;
    pointer-events:none;
  }
  .key.anim::after{
    width:280%;
    height:280%;
    opacity:1;
  }

  /* side panel (human tips + history) */
  .side {
    background: linear-gradient(180deg,#ffffff,#f6fbff);
    border-radius:12px;
    padding:12px;
    box-shadow: var(--shadow-2);
    min-height:520px;
  }
  .sticky {
    background: linear-gradient(180deg,#fff7e6,#fff5e0);
    border-radius:10px;
    padding:10px;
    border:1px solid rgba(0,0,0,0.03);
    color:#5b3b00;
    font-size:0.95rem;
    margin-bottom:12px;
    box-shadow: 0 6px 20px rgba(217,164,60,0.06);
  }
  .sticky h4{ margin:0 0 6px 0; font-size:1rem; font-weight:700; font-family:'Patrick Hand', cursive; }
  .sticky p{ margin:0; font-size:0.9rem; color:#6a5e3a; line-height:1.25 }

  .history-list { max-height:330px; overflow:auto; border-radius:8px; padding:6px; border:1px dashed rgba(3,17,28,0.03); background:linear-gradient(180deg,#fbfdff,#f3f8fb) }
  .history-item { padding:8px; border-bottom:1px solid rgba(3,17,28,0.04); display:flex; justify-content:space-between; gap:8px; align-items:center }
  .history-item:last-child{ border-bottom:none }
  .history-item button{ background:transparent; border:1px solid rgba(3,17,28,0.06); padding:6px 8px; border-radius:8px; cursor:pointer; font-size:0.85rem }

  /* autocomplete + hint + tooltip */
  .autocomplete {
    position: absolute;
    right: 56px;
    top: 112px;
    min-width: 300px;
    background: #10171b;
    color: #fff;
    border-radius:10px;
    box-shadow:0 18px 36px rgba(3,17,28,0.35);
    padding:6px;
    z-index:50;
    display:none;
  }
  .autocomplete.visible{ display:block }
  .autocomplete .suggest { padding:8px;border-radius:8px;cursor:pointer; display:flex;justify-content:space-between;gap:8px;align-items:center }
  .autocomplete .suggest:hover { background: rgba(255,255,255,0.04) }
  .autocomplete .sig { font-size:0.85rem; color:#9fd3ff }

  .hint {
    position:absolute;
    left:22px;
    top:112px;
    min-width:260px;
    padding:10px;
    border-radius:10px;
    background:#f6fffb;
    color:#0b3b3a;
    border:1px solid rgba(3,17,28,0.03);
    box-shadow: 0 12px 30px rgba(3,17,28,0.06);
    display:none;
    z-index:50;
  }
  .hint.visible{ display:block }
  .tooltip {
    position:fixed;
    pointer-events:none;
    padding:8px 10px;
    border-radius:8px;
    background:#0f1720;
    color:#fff;
    font-size:0.87rem;
    box-shadow:0 12px 30px rgba(3,17,28,0.5);
    display:none;
    z-index:80;
  }
  .tooltip.visible{ display:block }

  /* footer: human signature */
  .footer {
    grid-column:1 / -1;
    padding-top:8px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color:var(--muted);
    font-size:0.85rem;
  }

  /* responsive */
  @media (max-width:1000px){
    .calc{ grid-template-columns: 1fr; }
    .autocomplete{ right:16px; top:220px; }
    .hint{ left:16px; top:200px; }
  }
</style>
</head>
<body>

<div class="calc" id="calculator">

  <!-- Header -->
  <div class="header" role="banner">
    <div class="brand" aria-hidden="false">
      <h1>Exam-Calc</h1>
      <small>human-crafted • gentle UI • fast math</small>
    </div>

    <div class="controls">
      <button id="themeBtn" class="btn small" title="Toggle theme" aria-pressed="false"><i class="fas fa-moon"></i></button>
      <button id="copyBtn" class="btn small" title="Copy result"><i class="fas fa-copy"></i></button>
      <button id="helpBtn" class="btn small" title="Quick tips"><i class="fas fa-lightbulb"></i></button>
    </div>
  </div>

  <!-- Main area (left) -->
  <div class="main" aria-live="polite">

    <!-- Display -->
    <div class="display" role="region" aria-label="Calculator display">
      <div id="history" aria-hidden="true">&nbsp;</div>
      <div id="preview" aria-hidden="true">Type an expression — I'll preview it live ✨</div>
      <input id="display" aria-label="Calculator input" type="text" value="0" disabled />
    </div>

    <!-- Keys -->
    <div class="keys" id="keys" aria-hidden="false" style="margin-top:14px">

      <div class="row">
        <button class="key clr" data-action="clear">AC</button>
        <button class="key clr" data-action="back">⌫</button>
        <button class="key sci" data-fn="sqrt">√</button>
        <button class="key sci" data-fn="pow">xⁿ</button>
        <button class="key op" data-val="/">÷</button>
        <button class="key mem" data-action="mc">MC</button>
        <button class="key sci" data-fn="nCr">nCr</button>
        <button class="key sci" data-fn="nPr">nPr</button>
      </div>

      <div class="row">
        <button class="key sci" data-fn="sin">sin</button>
        <button class="key sci" data-fn="cos">cos</button>
        <button class="key sci" data-fn="tan">tan</button>
        <button class="key sci" data-fn="asin">asin</button>
        <button class="key sci" data-fn="acos">acos</button>
        <button class="key mem" data-action="mr">MR</button>
        <button class="key sci" data-fn="sinh">sinh</button>
        <button class="key sci" data-fn="cosh">cosh</button>
      </div>

      <div class="row">
        <button class="key num" data-val="7">7</button>
        <button class="key num" data-val="8">8</button>
        <button class="key num" data-val="9">9</button>
        <button class="key op" data-val="*">×</button>
        <button class="key sci" data-fn="fact">x!</button>
        <button class="key mem" data-action="mplus">M+</button>
        <button class="key sci" data-fn="gcd">gcd</button>
        <button class="key sci" data-fn="lcm">lcm</button>
      </div>

      <div class="row">
        <button class="key num" data-val="4">4</button>
        <button class="key num" data-val="5">5</button>
        <button class="key num" data-val="6">6</button>
        <button class="key op" data-val="-">−</button>
        <button class="key sci" data-fn="abs">|x|</button>
        <button class="key mem" data-action="mminus">M-</button>
        <button class="key sci" data-fn="isprime">isPrime</button>
        <button class="key sci" data-fn="pfactor">pfactor</button>
      </div>

      <div class="row">
        <button class="key num" data-val="1">1</button>
        <button class="key num" data-val="2">2</button>
        <button class="key num" data-val="3">3</button>
        <button class="key op" data-val="+">+</button>
        <button class="key sci" data-fn="exp">eˣ</button>
        <button class="key sci" data-fn="rand">RND</button>
        <button class="key sci" data-fn="asinh">asinh</button>
        <button class="key sci" data-fn="tanh">tanh</button>
      </div>

      <div class="row">
        <button class="key num" data-val="0">0</button>
        <button class="key num" data-val=".">.</button>
        <button class="key op" data-val="(">(</button>
        <button class="key op" data-val=")">)</button>
        <button class="key eq" data-action="equals">=</button>
        <button class="key sci" data-fn="pi">π</button>
        <button class="key sci" data-fn="floor">floor</button>
        <button class="key sci" data-fn="ceil">ceil</button>
      </div>

    </div>
  </div>

  <!-- Side column: tips & history -->
  <aside class="side" role="complementary">
    <div class="sticky" id="tip">
      <h4>Quick tip</h4>
      <p>Type an expression like <code>sin(30)</code> or <code>nCr(10,3)</code>. Try typing <em>pi</em> for π. Autocomplete, hints, and history to help you along.</p>
    </div>

    <div>
      <strong style="display:block;margin-bottom:8px;color:#123447">History</strong>
      <div class="history-list" id="historyList" aria-live="polite"></div>
    </div>

    <div style="margin-top:12px">
      <strong style="display:block;margin-bottom:8px;color:#123447">Settings</strong>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <label style="font-size:0.9rem;color:#557">Angle</label>
        <button id="angleToggle" class="small">Deg / Rad</button>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label style="font-size:0.9rem;color:#557">Precision</label>
        <select id="precision" class="small">
          <option>6</option><option>4</option><option>2</option><option>0</option><option>12</option>
        </select>
      </div>
    </div>

  </aside>

  <!-- global footer -->
  <div class="footer">
    <div>Designed with care — a gentle calculator for real people.</div>
    <div style="opacity:.8">vHuman • 1.0</div>
  </div>
</div>

<!-- autocomplete, hint and tooltip nodes (positioned absolute in display area) -->
<div class="autocomplete" id="autocomplete" role="listbox" aria-hidden="true"></div>
<div class="hint" id="argHint" aria-hidden="true"></div>
<div class="tooltip" id="tooltip" aria-hidden="true"></div>

<script>
/* ============================================================================
   Human Touch Calculator — JS
   - Features: fuzzy autocomplete, argument hints, tooltips, history, memory,
     trig deg/rad, precision, draggable UI-like behavior.
   - Style & microcopy updated to feel handcrafted/human.
   ============================================================================ */

(() => {
  // UI refs
  const displayEl = document.getElementById('display');
  const previewEl = document.getElementById('preview');
  const historyEl = document.getElementById('history');
  const keysEl = document.getElementById('keys');
  const historyList = document.getElementById('historyList');
  const autocomplete = document.getElementById('autocomplete');
  const argHint = document.getElementById('argHint');
  const tooltip = document.getElementById('tooltip');

  const themeBtn = document.getElementById('themeBtn');
  const copyBtn = document.getElementById('copyBtn');
  const helpBtn = document.getElementById('helpBtn');
  const angleToggle = document.getElementById('angleToggle');
  const precisionSelect = document.getElementById('precision');

  // state
  let expr = '';
  let memory = parseFloat(localStorage.getItem('human_calc_memory') || '0') || 0;
  let history = JSON.parse(localStorage.getItem('human_calc_history') || '[]');
  let angleMode = localStorage.getItem('human_calc_angle') || 'deg';
  let precision = parseInt(localStorage.getItem('human_calc_precision') || '6', 10);
  let isDark = localStorage.getItem('human_calc_theme') === 'dark';

  // catalog (short) for human docs + signatures
  const catalog = [
    {name:'sin', sig:'sin(x)', desc:'Sine — respects angle mode'},
    {name:'cos', sig:'cos(x)', desc:'Cosine — respects angle mode'},
    {name:'tan', sig:'tan(x)', desc:'Tangent — respects angle mode'},
    {name:'asin', sig:'asin(x)', desc:'Inverse sine'},
    {name:'acos', sig:'acos(x)', desc:'Inverse cosine'},
    {name:'atan', sig:'atan(x)', desc:'Inverse tangent'},
    {name:'sqrt', sig:'sqrt(x)', desc:'Square root'},
    {name:'pow', sig:'pow(a,b) or a^b', desc:'Exponent / power'},
    {name:'fact', sig:'fact(n) or n!', desc:'Factorial (integer)'},
    {name:'nCr', sig:'nCr(n,r)', desc:'Combinations'},
    {name:'nPr', sig:'nPr(n,r)', desc:'Permutations'},
    {name:'gcd', sig:'gcd(a,b)', desc:'Greatest common divisor'},
    {name:'lcm', sig:'lcm(a,b)', desc:'Least common multiple'},
    {name:'isprime', sig:'isprime(n)', desc:'Prime test (integer)'},
    {name:'pfactor', sig:'pfactor(n)', desc:'Prime factorization'},
    {name:'PI', sig:'PI', desc:'3.14159...'},
    {name:'E', sig:'E', desc:'2.71828...'},
    {name:'rand', sig:'rand()', desc:'Random 0..1'},
    {name:'floor', sig:'floor(x)', desc:'Round down'},
    {name:'ceil', sig:'ceil(x)', desc:'Round up'},
  ];

  // util: format numbers according to precision
  function fmtNumber(v) {
    if (typeof v === 'number' && isFinite(v)) {
      if (precision === 0) return String(Math.round(v));
      return Number.parseFloat(v).toFixed(precision).replace(/\.?0+$/,'');
    }
    return String(v);
  }

  // sandbox math helpers
  function factorial(n){
    const k = Math.floor(n);
    if (k < 0 || k !== n || k > 170) throw 'Invalid factorial';
    let r = 1;
    for (let i=2;i<=k;i++) r *= i;
    return r;
  }
  function gcd(a,b){ a=Math.abs(Math.floor(a)); b=Math.abs(Math.floor(b)); if(!a) return b; if(!b) return a; while(b){ const t=b; b=a%b; a=t;} return a; }
  function lcm(a,b){ if (a===0||b===0) return 0; return Math.abs(Math.floor(a)/gcd(a,b)*Math.floor(b)); }
  function isPrimeSimple(n){ n=Math.floor(n); if(n<=1) return false; if(n<=3) return true; if(n%2===0) return false; const r=Math.floor(Math.sqrt(n)); for(let i=3;i<=r;i+=2) if(n%i===0) return false; return true; }
  function primeFactors(n){ n=Math.abs(Math.floor(n)); const out=[]; let d=2; while(d*d<=n){ while(n%d===0){ out.push(d); n/=d; } d=(d===2)?3:d+2; } if(n>1) out.push(n); return out; }

  function buildSandbox() {
    return {
      sin: x => angleMode === 'deg' ? Math.sin(x*Math.PI/180) : Math.sin(x),
      cos: x => angleMode === 'deg' ? Math.cos(x*Math.PI/180) : Math.cos(x),
      tan: x => angleMode === 'deg' ? Math.tan(x*Math.PI/180) : Math.tan(x),
      asin: x => angleMode === 'deg' ? Math.asin(x)*180/Math.PI : Math.asin(x),
      acos: x => angleMode === 'deg' ? Math.acos(x)*180/Math.PI : Math.acos(x),
      atan: x => angleMode === 'deg' ? Math.atan(x)*180/Math.PI : Math.atan(x),
      sqrt: Math.sqrt,
      pow: (a,b) => Math.pow(a,b),
      abs: Math.abs,
      exp: Math.exp,
      rand: () => Math.random(),
      PI: Math.PI,
      E: Math.E,
      fact: factorial,
      nCr: (n,r) => {
        n = Math.floor(n); r = Math.floor(r);
        if (r<0 || n<0 || r>n) return 0;
        if (r > n - r) r = n - r;
        let num = 1, den = 1;
        for (let i=1;i<=r;i++){ num *= (n - r + i); den *= i; }
        return Math.round(num/den);
      },
      nPr: (n,r) => {
        n = Math.floor(n); r = Math.floor(r);
        if (r<0 || n<0 || r>n) return 0;
        let res = 1;
        for (let i=0;i<r;i++) res *= (n - i);
        return res;
      },
      gcd: (a,b) => gcd(a,b),
      lcm: (a,b) => lcm(a,b),
      isprime: (n) => isPrimeSimple(n),
      pfactor: (n) => primeFactors(n),
      floor: (x) => Math.floor(x),
      ceil: (x) => Math.ceil(x),
      round: (x) => Math.round(x)
    };
  }

  // preprocess: factorial, percent, ^ operator
  function preprocess(expr) {
    let s = expr.replace(/\s+/g,'');
    const reFact = /(\d+(\.\d+)?|\([^()]*\))!/;
    while (reFact.test(s)) s = s.replace(reFact, 'fact($1)');
    s = s.replace(/(\d+(\.\d+)?)%/g, '($1/100)');
    // a^b -> pow(a,b)
    s = s.replace(/([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))\^([A-Za-z_]\w*|\d+(\.\d+)?|\([^()]*\))/g, 'pow($1,$3)');
    return s;
  }

  function safeEval(expression) {
    if (!expression || expression.trim() === '') return '';
    try {
      const processed = preprocess(expression);
      const sb = buildSandbox();
      const keys = Object.keys(sb);
      const args = keys.map(k => sb[k]);
      const fn = new Function(...keys, 'return (' + processed + ');');
      const res = fn(...args);
      return res;
    } catch (err) {
      return 'Error';
    }
  }

  // renderers
  function renderDisplay() {
    displayEl.value = expr || '0';
    historyEl.textContent = history.length ? history[history.length-1].expr + ' =' : '\u00A0';
  }
  function renderHistoryList(){
    historyList.innerHTML = '';
    if (!history.length) { historyList.innerHTML = '<div style="padding:10px;color:#456">No history yet — your recent calculations will appear here.</div>'; return; }
    for (let i = history.length - 1; i >= 0; i--) {
      const it = history[i];
      const el = document.createElement('div');
      el.className = 'history-item';
      el.innerHTML = `<div style="flex:1"><strong>${it.expr}</strong><div style="font-size:0.85rem;color:#667">${fmtNumber(it.result)}</div></div>
                      <div style="display:flex;gap:6px"><button data-load="${i}">Load</button><button data-copy="${i}">Copy</button></div>`;
      historyList.appendChild(el);
    }
  }

  // interactions
  keysEl.addEventListener('click', e => {
    const btn = e.target.closest('.key');
    if (!btn) return;
    // quick ripple animation
    btn.classList.add('anim');
    setTimeout(()=>btn.classList.remove('anim'), 220);
    const val = btn.getAttribute('data-val');
    const action = btn.getAttribute('data-action');
    const fn = btn.getAttribute('data-fn');

    if (val) { expr += val; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if (fn) {
      if (!expr) {
        if (fn === 'pi') expr += 'PI';
        else if (fn === 'rand') expr += 'rand()';
        else expr += fn + '(';
      } else {
        if (['fact','rand','pi','isprime','pfactor'].includes(fn)) {
          if (fn === 'fact') expr = 'fact(' + expr + ')';
          else if (fn === 'rand') expr = 'rand()';
          else if (fn === 'pi') expr += 'PI';
          else if (fn === 'isprime') expr = 'isprime(' + expr + ')';
          else if (fn === 'pfactor') expr = 'pfactor(' + expr + ')';
        } else if (fn === 'pow') {
          expr += '^';
        } else {
          expr = fn + '(' + expr + ')';
        }
      }
      renderDisplay(); schedulePreview(); updateAutocomplete(); updateArgHint();
      return;
    }

    if (action) {
      switch (action) {
        case 'clear': expr = ''; renderDisplay(); previewEl.textContent = "Type an expression — I'll preview it live ✨"; hideAutocomplete(); hideArgHint(); break;
        case 'back': expr = expr.slice(0, -1); renderDisplay(); schedulePreview(); updateAutocomplete(); updateArgHint(); break;
        case 'equals': {
          const v = safeEval(expr);
          if (v !== 'Error' && v !== '' && v !== undefined) {
            history.push({expr: expr, result: v});
            if (history.length > 300) history.shift();
            localStorage.setItem('human_calc_history', JSON.stringify(history));
            expr = String(v);
            renderHistoryList();
            previewEl.textContent = '';
          } else {
            previewEl.textContent = 'Error';
          }
          renderDisplay(); hideAutocomplete(); hideArgHint();
        } break;
        case 'mc': memory = 0; localStorage.setItem('human_calc_memory', String(memory)); break;
        case 'mr': expr += String(memory); renderDisplay(); schedulePreview(); updateAutocomplete(); break;
        case 'mplus': { const v = safeEval(expr); if (typeof v === 'number' && isFinite(v)) memory += v; localStorage.setItem('human_calc_memory', String(memory)); } break;
        case 'mminus': { const v = safeEval(expr); if (typeof v === 'number' && isFinite(v)) memory -= v; localStorage.setItem('human_calc_memory', String(memory)); } break;
      }
    }
  });

  // history panel actions (load/copy)
  historyList.addEventListener('click', e => {
    const load = e.target.getAttribute('data-load');
    const copy = e.target.getAttribute('data-copy');
    if (load) {
      const it = history[load];
      if (it) { expr = it.expr; renderDisplay(); schedulePreview(); }
    }
    if (copy) {
      const it = history[copy];
      if (it) navigator.clipboard?.writeText(String(it.result)).catch(()=>{});
    }
  });

  // keyboard support + autocomplete navigation
  let suggestions = [], suggestionIndex = -1;
  document.addEventListener('keydown', e => {
    if (autocomplete.style.display === 'block') {
      if (e.key === 'ArrowDown') { e.preventDefault(); suggestionIndex = (suggestionIndex + 1) % suggestions.length; renderAutocomplete(); return; }
      if (e.key === 'ArrowUp') { e.preventDefault(); suggestionIndex = (suggestionIndex - 1 + suggestions.length) % suggestions.length; renderAutocomplete(); return; }
      if (e.key === 'Enter' && suggestionIndex >= 0) { acceptSuggestion(suggestionIndex); e.preventDefault(); return; }
      if (e.key === 'Escape') { hideAutocomplete(); hideArgHint(); return; }
    }

    if (e.key >= '0' && e.key <= '9') { expr += e.key; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if (e.key === '.') { expr += '.'; renderDisplay(); schedulePreview(); updateAutocomplete(); return; }
    if ('+-*/%^()'.includes(e.key)) { expr += e.key; renderDisplay(); schedulePreview(); updateArgHint(); return; }
    if (e.key === 'Enter') { document.querySelector('[data-action="equals"]').click(); return; }
    if (e.key === 'Backspace') { document.querySelector('[data-action="back"]').click(); return; }
    if (e.key === 'Escape') { document.querySelector('[data-action="clear"]').click(); return; }
    if (/^[a-zA-Z]$/.test(e.key)) { expr += e.key; renderDisplay(); updateAutocomplete(); schedulePreview(); return; }
    if (e.key === '!') { expr += '!'; renderDisplay(); schedulePreview(); return; }
  });

  // autocomplete: fuzzy substring match
  function updateAutocomplete(){
    const tokenMatch = expr.match(/[A-Za-z_]+$/);
    const token = tokenMatch ? tokenMatch[0] : '';
    if (!token) { hideAutocomplete(); return; }
    const low = token.toLowerCase();
    suggestions = catalog.filter(c => c.name.toLowerCase().includes(low)).slice(0, 10);
    suggestionIndex = suggestions.length ? 0 : -1;
    renderAutocomplete();
  }
  function renderAutocomplete(){
    autocomplete.innerHTML = '';
    if (!suggestions.length) return hideAutocomplete();
    suggestions.forEach((s,i) => {
      const el = document.createElement('div');
      el.className = 'suggest';
      el.dataset.index = i;
      el.innerHTML = `<div><strong>${s.name}</strong><div style="font-size:0.85rem;color:#88b6d6">${s.desc}</div></div><div class="sig">${s.sig||''}</div>`;
      el.addEventListener('click', ()=> acceptSuggestion(i));
      el.addEventListener('mousemove', (ev)=> showTooltip(s.sig + ' — ' + s.desc, ev.clientX+10, ev.clientY+10));
      el.addEventListener('mouseleave', hideTooltip);
      autocomplete.appendChild(el);
    });
    autocomplete.style.display = 'block';
    autocomplete.setAttribute('aria-hidden', 'false');
  }
  function hideAutocomplete(){ autocomplete.style.display = 'none'; autocomplete.setAttribute('aria-hidden','true'); suggestions=[]; suggestionIndex=-1; }

  function acceptSuggestion(i){
    if (i<0 || i>=suggestions.length) return;
    const s = suggestions[i];
    const tokenMatch = expr.match(/[A-Za-z_]+$/);
    if (tokenMatch) expr = expr.slice(0, -tokenMatch[0].length);
    expr += (s.sig && s.type !== 'const') ? (s.name+'(') : s.name;
    renderDisplay(); hideAutocomplete(); schedulePreview(); updateArgHint();
  }

  // argument hint detection
  function updateArgHint() {
    const m = expr.match(/([A-Za-z_]\w*)\([^()]*$/);
    if (!m) return hideArgHint();
    const name = m[1];
    const entry = catalog.find(c => c.name === name);
    if (!entry) return hideArgHint();
    argHint.innerHTML = `<strong>${entry.sig}</strong><div style="margin-top:6px;font-size:0.9rem;color:#274b4f">${entry.desc}</div>`;
    argHint.style.display = 'block';
  }
  function hideArgHint(){ argHint.style.display = 'none'; }

  // preview + debounce
  let previewTimer = null;
  function schedulePreview(){
    if (previewTimer) clearTimeout(previewTimer);
    previewTimer = setTimeout(()=> {
      const v = safeEval(expr);
      previewEl.textContent = (v === 'Error' || v === '' ? '…' : '≈ ' + fmtNumber(v));
    }, 120);
  }

  // tooltip
  function showTooltip(text, x, y){
    tooltip.textContent = text;
    tooltip.style.left = (x + 8) + 'px';
    tooltip.style.top = (y + 8) + 'px';
    tooltip.style.display = 'block';
  }
  function hideTooltip(){ tooltip.style.display = 'none'; }

  // small UI controls
  document.getElementById('angleToggle').addEventListener('click', () => {
    angleMode = angleMode === 'deg' ? 'rad' : 'deg';
    localStorage.setItem('human_calc_angle', angleMode);
    document.getElementById('angleToggle').textContent = 'Mode: ' + angleMode.toUpperCase();
    schedulePreview();
  });
  precisionSelect.addEventListener('change', () => {
    precision = parseInt(precisionSelect.value || '6', 10);
    localStorage.setItem('human_calc_precision', String(precision));
    schedulePreview();
  });
  themeBtn.addEventListener('click', () => {
    isDark = !isDark;
    localStorage.setItem('human_calc_theme', isDark ? 'dark' : 'light');
    document.body.classList.toggle('dark', isDark);
  });
  copyBtn.addEventListener('click', async () => {
    try { await navigator.clipboard.writeText(displayEl.value || ''); copyBtn.classList.add('anim'); setTimeout(()=>copyBtn.classList.remove('anim'),220); } catch {}
  });
  helpBtn.addEventListener('click', () => {
    const tip = document.getElementById('tip');
    tip.style.display = tip.style.display === 'none' || tip.style.display === '' ? 'block' : 'none';
    tip.scrollIntoView({behavior:'smooth', block:'center'});
  });

  // init / render initial UI
  function init() {
    displayEl.value = '0';
    document.getElementById('angleToggle').textContent = 'Mode: ' + angleMode.toUpperCase();
    precisionSelect.value = String(precision);
    if (isDark) document.body.classList.add('dark');
    renderDisplay(); renderHistoryList();
  }
  init();

  // Utility: expose evaluate for debugging
  window.humanCalc = { evaluate: safeEval };

})();
</script>
</body>
</html>
